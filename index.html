<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okasha Communication | Complete Professional POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <style>
        /* Original styles - exactly as before */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1e40af;
            --secondary: #0f172a;
            --accent: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        body.light-mode {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
        }
        
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .light-mode .glass {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(203, 213, 225, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .blue-glow:hover { 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); 
            border-color: var(--accent); 
            transition: all 0.3s ease; 
        }
        
        .gradient-text {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .light-mode .gradient-text {
            background: linear-gradient(90deg, #1d4ed8, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }
        
        .light-mode ::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 10px;
        }
        
        /* Product Image */
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        .product-image-large {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        /* Cart Item */
        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        /* Payment Badges */
        .payment-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        .payment-cash { background: #10b98120; color: #10b981; }
        .payment-easypaisa { background: #3b82f620; color: #3b82f6; }
        .payment-jazzcash { background: #8b5cf620; color: #8b5cf6; }
        .payment-card { background: #f59e0b20; color: #f59e0b; }
        .payment-loan { background: #ef444420; color: #ef4444; }
        .payment-load { background: #ec489920; color: #ec4899; }
        .payment-bank { background: #14b8a620; color: #14b8a6; }
        .payment-print { background: #a855f720; color: #a855f7; }
        .payment-form { background: #06b6d420; color: #06b6d4; }
        
        /* Service Badges */
        .service-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .service-easyload { background: #10b98120; color: #10b981; }
        .service-print { background: #a855f720; color: #a855f7; }
        .service-photocopy { background: #f9731620; color: #f97316; }
        .service-form { background: #06b6d420; color: #06b6d4; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Camera Preview */
        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        /* Invoice Print */
        .invoice-container {
            background: white;
            color: #1e293b;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .invoice-header {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .invoice-items th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .invoice-items td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .invoice-totals {
            border-top: 2px solid #3b82f6;
            padding-top: 20px;
            margin-top: 30px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-container, .invoice-container * {
                visibility: visible;
            }
            .invoice-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        /* Status Indicators */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active { background-color: var(--success); }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 99;
        }
        
        .connection-status {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 100;
            font-size: 12px;
        }
        .connection-status.online { color: #10b981; }
        .connection-status.offline { color: #ef4444; }
        
        .version-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #94a3b8;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            z-index: 98;
        }

        .location-badge {
            position: fixed;
            bottom: 20px;
            right: 120px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 98;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Button Styles - Fixed for INP issue */
        button {
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        /* Improved scroll performance */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Sync Indicator -->
    <div id="sync-indicator" class="sync-indicator">
        <i class="fas fa-circle text-green-400 text-xs"></i>
        <span>Cloud Sync Active</span>
    </div>

    <!-- Location Badge -->
    <div class="location-badge">
        <i class="fas fa-map-marker-alt"></i>
        Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="connection-status online">
        <i class="fas fa-wifi"></i> <span>Internet Connected</span>
    </div>

    <!-- Version Badge -->
    <div class="version-badge">
        <i class="fas fa-cloud mr-1"></i> v6.2 - INP Fixed
    </div>

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="theme-toggle no-print">
        <i class="fas fa-moon text-blue-400"></i>
    </button>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="w-full min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-950">
        <div class="glass p-8 rounded-3xl w-full max-w-md animate-fadeIn">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-store text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold gradient-text mb-2">OKASHA <span class="text-white">COMMUNICATION</span></h1>
                <p class="text-gray-400">Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid</p>
                <p class="text-xs text-gray-500 mt-2">Mobile Sale, Purchase, Repair & All Services</p>
            </div>
            
            <div class="flex gap-2 mb-6">
                <button id="btn-admin" class="flex-1 py-3 rounded-lg bg-blue-900/50 text-blue-300 font-medium border border-blue-700/50" onclick="selectRole('admin')">
                    <i class="fas fa-user-shield mr-2"></i>Admin
                </button>
                <button id="btn-worker" class="flex-1 py-3 rounded-lg bg-slate-800 text-slate-300 font-medium border border-slate-700" onclick="selectRole('worker')">
                    <i class="fas fa-user-tie mr-2"></i>Worker
                </button>
            </div>
            
            <div id="login-error" class="hidden mb-4 p-3 bg-red-900/30 border border-red-700/50 rounded-lg text-red-300 text-sm">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="error-message">Invalid credentials</span>
            </div>
            
            <form id="login-form" class="space-y-5" onsubmit="event.preventDefault(); handleLogin();">
                <div id="role-info" class="p-3 bg-slate-800/50 rounded-lg">
                    <p class="text-sm text-gray-400 mb-1">Selected Role: <span id="selected-role" class="text-blue-300 font-medium">Admin</span></p>
                    <p class="text-xs text-gray-500" id="role-description">Full access to add products, view analytics, and manage system</p>
                </div>
                
                <div>
                    <label class="block text-gray-400 text-sm mb-2">
                        <i class="fas fa-key mr-2"></i>Password
                    </label>
                    <div class="relative">
                        <div class="absolute left-3 top-3 text-gray-500">
                            <i class="fas fa-lock"></i>
                        </div>
                        <input type="password" id="password" placeholder="Enter password" 
                               class="w-full bg-slate-900 border border-slate-700 p-3 pl-12 rounded-lg focus:outline-none focus:border-blue-500">
                        <button type="button" onclick="togglePassword()" class="absolute right-3 top-3 text-gray-500 hover:text-blue-400">
                            <i class="fas fa-eye" id="password-toggle"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-bold py-3 rounded-lg transition duration-300">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>LOGIN TO SYSTEM
                </button>
            </form>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="admin-dashboard" class="hidden min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-shield text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">OKASHA <span class="text-white">COMMUNICATION</span></h1>
                        <p class="text-gray-400 text-sm flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-blue-400"></i>
                            Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid
                            <span class="status-dot status-active"></span>
                        </p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <span class="px-3 py-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-full text-xs font-medium">
                        <i class="fas fa-user-shield mr-1"></i> Admin Panel
                    </span>
                    <button onclick="showAnalytics()" class="px-3 py-1 bg-purple-900/30 text-purple-300 rounded-full text-xs font-medium hover:bg-purple-900/50">
                        <i class="fas fa-chart-bar mr-1"></i> Analytics
                    </button>
                    <button onclick="showReports()" class="px-3 py-1 bg-green-900/30 text-green-300 rounded-full text-xs font-medium hover:bg-green-900/50">
                        <i class="fas fa-file-alt mr-1"></i> Reports
                    </button>
                    <button onclick="showLoans()" class="px-3 py-1 bg-yellow-900/30 text-yellow-300 rounded-full text-xs font-medium hover:bg-yellow-900/50">
                        <i class="fas fa-hand-holding-usd mr-1"></i> Loans
                    </button>
                    <button onclick="showServices()" class="px-3 py-1 bg-indigo-900/30 text-indigo-300 rounded-full text-xs font-medium hover:bg-indigo-900/50">
                        <i class="fas fa-cogs mr-1"></i> Services
                    </button>
                    <button onclick="showWorkerSales()" class="px-3 py-1 bg-pink-900/30 text-pink-300 rounded-full text-xs font-medium hover:bg-pink-900/50">
                        <i class="fas fa-users mr-1"></i> Worker Sales
                    </button>
                    <button onclick="showPasswordManager()" class="px-3 py-1 bg-gray-900/30 text-gray-300 rounded-full text-xs font-medium hover:bg-gray-900/50">
                        <i class="fas fa-key mr-1"></i> Passwords
                    </button>
                    <button onclick="backupData()" class="px-3 py-1 bg-slate-800 text-slate-300 rounded-full text-xs font-medium hover:bg-slate-700">
                        <i class="fas fa-database mr-1"></i> Backup
                    </button>
                    <button onclick="logout()" class="px-3 py-1 bg-red-900/30 text-red-300 rounded-full text-xs font-medium hover:bg-red-900/50">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
            <div class="text-right">
                <div class="glass px-4 py-3 rounded-xl inline-block">
                    <p id="admin-date" class="text-sm text-blue-400 font-mono"></p>
                    <p id="admin-time" class="text-lg font-bold font-mono"></p>
                </div>
                <p class="text-xs text-gray-500 mt-2">Session: <span id="admin-session-time">00:00:00</span></p>
                <p class="text-xs text-green-400 mt-1" id="last-update">Updated: Just now</p>
            </div>
        </header>

        <!-- Shop Contact Info -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass p-4 rounded-xl flex items-center gap-3">
                <div class="w-10 h-10 bg-green-900/30 rounded-lg flex items-center justify-center">
                    <i class="fas fa-mobile-alt text-green-400"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-400">Easypaisa</p>
                    <p class="font-bold">0311-5463213</p>
                </div>
            </div>
            <div class="glass p-4 rounded-xl flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-900/30 rounded-lg flex items-center justify-center">
                    <i class="fas fa-university text-blue-400"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-400">Askari Bank</p>
                    <p class="font-bold text-sm">00550350004927</p>
                </div>
            </div>
            <div class="glass p-4 rounded-xl flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-900/30 rounded-lg flex items-center justify-center">
                    <i class="fas fa-map-pin text-purple-400"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-400">Location</p>
                    <p class="font-bold text-sm">Liaq Ali Chowk Shop #5</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="glass p-5 rounded-xl border-l-4 border-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Total Revenue</p>
                        <h2 class="text-2xl font-bold">Rs. <span id="admin-revenue">0</span></h2>
                    </div>
                    <div class="w-10 h-10 bg-blue-900/30 rounded-lg flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-blue-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass p-5 rounded-xl border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Total Profit</p>
                        <h2 class="text-2xl font-bold text-green-400">Rs. <span id="admin-profit">0</span></h2>
                    </div>
                    <div class="w-10 h-10 bg-green-900/30 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-pie text-green-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass p-5 rounded-xl border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Items in Stock</p>
                        <h2 class="text-2xl font-bold text-purple-400" id="admin-stock-count">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-purple-900/30 rounded-lg flex items-center justify-center">
                        <i class="fas fa-boxes text-purple-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass p-5 rounded-xl border-l-4 border-yellow-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Today's Sales</p>
                        <h2 class="text-2xl font-bold text-yellow-400" id="admin-today-sales">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-yellow-900/30 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shopping-cart text-yellow-400"></i>
                    </div>
                </div>
            </div>
            <div class="glass p-5 rounded-xl border-l-4 border-pink-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Services Today</p>
                        <h2 class="text-2xl font-bold text-pink-400" id="admin-services">0</h2>
                    </div>
                    <div class="w-10 h-10 bg-pink-900/30 rounded-lg flex items-center justify-center">
                        <i class="fas fa-cogs text-pink-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Add Product with Image -->
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-blue-400"></i>
                    Add Product with Image
                </h3>
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-blue-500/30 rounded-lg p-4 text-center">
                        <input type="file" id="product-image" accept="image/*" class="hidden" onchange="previewImage(event)">
                        <button type="button" onclick="document.getElementById('product-image').click()" class="bg-blue-900/30 text-blue-300 px-4 py-2 rounded-lg">
                            <i class="fas fa-camera mr-2"></i>Upload Image
                        </button>
                        <div id="image-preview" class="mt-3 hidden">
                            <img src="" class="w-24 h-24 object-cover rounded-lg mx-auto">
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Click to upload product image</p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Product Name</label>
                        <input type="text" id="admin-product-name" placeholder="e.g., Samsung Galaxy S23" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">Barcode</label>
                            <input type="text" id="admin-barcode" placeholder="Optional" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">Category</label>
                            <select id="admin-category" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                                <option value="mobile">Mobile Phone</option>
                                <option value="accessory">Accessory</option>
                                <option value="repair">Repair Service</option>
                                <option value="load">Easyload/Balance</option>
                                <option value="print">Print/Photocopy</option>
                                <option value="form">Forms/Application</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">Cost Price</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-500">Rs.</span>
                                <input type="number" id="admin-cost-price" placeholder="0" class="w-full bg-slate-900 border border-slate-700 p-3 pl-10 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">Sell Price</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-500">Rs.</span>
                                <input type="number" id="admin-sell-price" placeholder="0" class="w-full bg-slate-900 border border-slate-700 p-3 pl-10 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Quantity</label>
                        <div class="flex items-center">
                            <button type="button" onclick="decreaseQuantity()" class="bg-slate-800 text-white w-10 h-10 rounded-l-lg">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="admin-quantity" value="1" min="1" class="w-full bg-slate-900 border-y border-slate-700 p-3 text-center">
                            <button type="button" onclick="increaseQuantity()" class="bg-slate-800 text-white w-10 h-10 rounded-r-lg">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" onclick="addProductAdmin()" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white py-3 rounded-lg">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>ADD TO CLOUD
                    </button>
                </div>
            </div>

            <!-- Products List with Images -->
            <div class="glass p-6 rounded-2xl lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-boxes text-purple-400"></i>
                        Inventory Management
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="admin-search" placeholder="Search products..." class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">
                        <button type="button" onclick="refreshAdmin()" class="bg-blue-900/30 text-blue-300 p-2 rounded-lg">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="admin-products-list" class="space-y-3 max-h-[500px] overflow-y-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Services & Loans -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-hand-holding-usd text-yellow-400"></i>
                    Active Loans
                </h3>
                <div id="loans-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                    <!-- Loans will appear here -->
                </div>
            </div>
            
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-cogs text-pink-400"></i>
                    Recent Services
                </h3>
                <div id="services-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                    <!-- Services will appear here -->
                </div>
            </div>
        </div>

        <!-- Recent Sales -->
        <div class="glass p-6 rounded-2xl mb-8">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-history text-blue-400"></i>
                Recent Sales
            </h3>
            <div id="admin-sales-history" class="space-y-3 max-h-[300px] overflow-y-auto">
                <!-- Sales will appear here -->
            </div>
        </div>

        <!-- Worker Activity -->
        <div class="glass p-6 rounded-2xl">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-bell text-green-400"></i>
                Worker Activity
            </h3>
            <div id="worker-activity" class="space-y-3 max-h-[300px] overflow-y-auto">
                <!-- Activity will appear here -->
            </div>
        </div>
    </div>

    <!-- WORKER DASHBOARD -->
    <div id="worker-dashboard" class="hidden min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div class="mb-4 md:mb-0">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-600 to-green-800 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-tie text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">OKASHA <span class="text-white">COMMUNICATION</span></h1>
                        <p class="text-gray-400 text-sm flex items-center gap-2">
                            <i class="fas fa-map-marker-alt text-green-400"></i>
                            Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid
                            <span class="status-dot status-active"></span>
                        </p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                    <span class="px-3 py-1 bg-gradient-to-r from-green-600 to-green-800 text-white rounded-full text-xs font-medium">
                        <i class="fas fa-user-tie mr-1"></i> Sale Counter
                    </span>
                    <button type="button" onclick="scanBarcode()" class="px-3 py-1 bg-purple-900/30 text-purple-300 rounded-full text-xs font-medium hover:bg-purple-900/50">
                        <i class="fas fa-camera mr-1"></i> Scan Barcode
                    </button>
                    <button type="button" onclick="showServicePanel()" class="px-3 py-1 bg-indigo-900/30 text-indigo-300 rounded-full text-xs font-medium hover:bg-indigo-900/50">
                        <i class="fas fa-cogs mr-1"></i> Services
                    </button>
                    <button type="button" onclick="showMySales()" class="px-3 py-1 bg-blue-900/30 text-blue-300 rounded-full text-xs font-medium hover:bg-blue-900/50">
                        <i class="fas fa-chart-line mr-1"></i> My Sales
                    </button>
                    <button type="button" onclick="generateDailyInvoice()" class="px-3 py-1 bg-yellow-900/30 text-yellow-300 rounded-full text-xs font-medium hover:bg-yellow-900/50">
                        <i class="fas fa-receipt mr-1"></i> Daily Invoice
                    </button>
                    <button type="button" onclick="logout()" class="px-3 py-1 bg-red-900/30 text-red-300 rounded-full text-xs font-medium hover:bg-red-900/50">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
            <div class="text-right">
                <div class="glass px-4 py-3 rounded-xl inline-block">
                    <p id="worker-date" class="text-sm text-green-400 font-mono"></p>
                    <p id="worker-time" class="text-lg font-bold font-mono"></p>
                </div>
                <p class="text-xs text-gray-500 mt-2">Today's Sales: <span id="worker-today-total">Rs. 0</span></p>
                <p class="text-xs text-green-400 mt-1" id="worker-last-update">Updated: Just now</p>
            </div>
        </header>

        <!-- Shop Contact Info for Worker -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass p-3 rounded-xl flex items-center gap-2">
                <i class="fas fa-mobile-alt text-green-400"></i>
                <span class="text-sm">Easypaisa: 0311-5463213</span>
            </div>
            <div class="glass p-3 rounded-xl flex items-center gap-2">
                <i class="fas fa-university text-blue-400"></i>
                <span class="text-sm">Askari: 00550350004927</span>
            </div>
            <div class="glass p-3 rounded-xl flex items-center gap-2">
                <i class="fas fa-map-pin text-purple-400"></i>
                <span class="text-sm">Liaq Ali Chowk Shop #5</span>
            </div>
        </div>

        <!-- Worker Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="glass p-4 rounded-xl border-l-4 border-green-500">
                <p class="text-gray-400 text-sm">Available Products</p>
                <h2 class="text-2xl font-bold text-green-400" id="worker-available-products">0</h2>
            </div>
            <div class="glass p-4 rounded-xl border-l-4 border-blue-500">
                <p class="text-gray-400 text-sm">Today's Sales</p>
                <h2 class="text-2xl font-bold text-blue-400" id="worker-today-count">0</h2>
            </div>
            <div class="glass p-4 rounded-xl border-l-4 border-yellow-500">
                <p class="text-gray-400 text-sm">Session Sales</p>
                <h2 class="text-2xl font-bold text-yellow-400">Rs. <span id="worker-session-total">0</span></h2>
            </div>
            <div class="glass p-4 rounded-xl border-l-4 border-purple-500">
                <p class="text-gray-400 text-sm">Services Today</p>
                <h2 class="text-2xl font-bold text-purple-400" id="worker-services-count">0</h2>
            </div>
        </div>

        <!-- Service Panel Modal -->
        <div id="service-panel-modal" class="modal">
            <div class="glass p-6 rounded-2xl max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Services Panel</h3>
                    <button type="button" onclick="closeServicePanel()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                    <!-- Easyload Service -->
                    <div class="p-4 bg-green-900/20 rounded-lg">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <i class="fas fa-mobile-alt text-green-400"></i>
                            Easyload / Balance Transfer
                        </h4>
                        <div class="space-y-3">
                            <input type="text" id="easyload-number" placeholder="Mobile Number (e.g., 03xxxxxxxxx)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <input type="number" id="easyload-amount" placeholder="Amount (Rs.)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <select id="easyload-company" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                                <option value="jazz">Jazz</option>
                                <option value="warid">Warid</option>
                                <option value="ufone">Ufone</option>
                                <option value="telenor">Telenor</option>
                                <option value="zong">Zong</option>
                            </select>
                            <button type="button" onclick="processEasyload()" class="w-full bg-green-900/30 text-green-300 py-2 rounded-lg hover:bg-green-900/50">
                                Process Easyload
                            </button>
                        </div>
                    </div>

                    <!-- Print / Photocopy Service -->
                    <div class="p-4 bg-purple-900/20 rounded-lg">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <i class="fas fa-print text-purple-400"></i>
                            Print / Photocopy
                        </h4>
                        <div class="space-y-3">
                            <select id="print-type" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                                <option value="print">Print (Black & White)</option>
                                <option value="print-color">Print (Color)</option>
                                <option value="photocopy">Photocopy (B&W)</option>
                                <option value="photocopy-color">Photocopy (Color)</option>
                                <option value="scan">Scan</option>
                            </select>
                            <input type="number" id="print-pages" placeholder="Number of Pages" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <input type="number" id="print-price" placeholder="Price per page (Rs.)" value="5" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <button type="button" onclick="processPrint()" class="w-full bg-purple-900/30 text-purple-300 py-2 rounded-lg hover:bg-purple-900/50">
                                Process Print / Photocopy
                            </button>
                        </div>
                    </div>

                    <!-- Forms / Applications -->
                    <div class="p-4 bg-blue-900/20 rounded-lg">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <i class="fas fa-file-alt text-blue-400"></i>
                            Forms / Applications
                        </h4>
                        <div class="space-y-3">
                            <select id="form-type" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                                <option value="nadra">Nadra Form</option>
                                <option value="passport">Passport Application</option>
                                <option value="nic">CNIC/B-Form</option>
                                <option value="vehicle">Vehicle Registration</option>
                                <option value="other">Other Form</option>
                            </select>
                            <input type="text" id="form-customer" placeholder="Customer Name" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <input type="number" id="form-price" placeholder="Price (Rs.)" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                            <button type="button" onclick="processForm()" class="w-full bg-blue-900/30 text-blue-300 py-2 rounded-lg hover:bg-blue-900/50">
                                Process Form Application
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <button type="button" onclick="closeServicePanel()" class="bg-slate-800 text-gray-300 px-6 py-2 rounded-lg hover:bg-slate-700">
                        Close Panel
                    </button>
                </div>
            </div>
        </div>

        <!-- Scanner Modal -->
        <div id="scanner-modal" class="modal">
            <div class="glass p-6 rounded-2xl max-w-md w-full">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-camera text-purple-400"></i>
                    Scan Barcode
                </h3>
                <div class="camera-preview bg-black rounded-lg flex items-center justify-center">
                    <p class="text-gray-400 text-sm">Camera preview would appear here</p>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">Or enter barcode manually</p>
                <div class="flex gap-2 mt-3">
                    <input type="text" id="manual-barcode" placeholder="Enter barcode" class="flex-1 bg-slate-900 border border-slate-700 p-3 rounded-lg">
                    <button type="button" onclick="searchByBarcode()" class="bg-blue-900/30 text-blue-300 px-4 rounded-lg">Find</button>
                </div>
                <button type="button" onclick="closeScanner()" class="w-full mt-4 bg-slate-800 text-gray-300 py-2 rounded-lg">Close</button>
            </div>
        </div>

        <!-- My Sales Modal -->
        <div id="my-sales-modal" class="modal">
            <div class="glass p-6 rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">My Sales Report</h3>
                    <button type="button" onclick="closeMySales()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="my-sales-list" class="space-y-3">
                    <!-- Worker's sales will appear here -->
                </div>
            </div>
        </div>

        <!-- Main POS Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Products Grid -->
            <div class="glass p-6 rounded-2xl lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-boxes text-green-400"></i>
                        Products with Images
                    </h3>
                    <input type="text" id="worker-search" placeholder="Search..." class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm w-40">
                </div>
                <div id="worker-products-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Shopping Cart -->
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-shopping-cart text-green-400"></i>
                    Current Sale
                    <span class="text-xs bg-blue-900/30 text-blue-300 px-2 py-1 rounded-full ml-2" id="cart-count">0</span>
                </h3>
                
                <div id="cart-items" class="space-y-2 max-h-[300px] overflow-y-auto mb-4">
                    <!-- Cart items appear here -->
                </div>
                
                <div class="border-t border-slate-700 pt-4 mb-4">
                    <div class="flex justify-between mb-2">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">Rs. 0</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total:</span>
                        <span id="cart-total" class="text-green-400">Rs. 0</span>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="mb-4">
                    <label class="block text-gray-400 text-sm mb-2">Payment Method</label>
                    <select id="payment-method" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                        <option value="cash">Cash</option>
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="loan">Loan / Credit</option>
                    </select>
                </div>

                <!-- Conditional Fields -->
                <div id="loan-customer-div" class="mb-4 hidden">
                    <label class="block text-gray-400 text-sm mb-2">Customer Name <span class="text-red-400">*</span></label>
                    <input type="text" id="loan-customer" placeholder="Required for loan" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                </div>

                <div id="mobile-number-div" class="mb-4 hidden">
                    <label class="block text-gray-400 text-sm mb-2">Mobile Number <span class="text-red-400">*</span></label>
                    <input type="text" id="mobile-number" placeholder="03xxxxxxxxx" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                </div>

                <!-- Transaction ID - Optional -->
                <div class="mb-4">
                    <label class="block text-gray-400 text-sm mb-2">
                        Transaction ID / Reference 
                        <span class="text-gray-500 text-xs">(Optional)</span>
                    </label>
                    <input type="text" id="payment-ref" placeholder="e.g., TID123456" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="processSale()" class="flex-1 bg-gradient-to-r from-green-600 to-green-800 text-white py-3 rounded-lg">
                        <i class="fas fa-check mr-2"></i>Complete Sale
                    </button>
                    <button type="button" onclick="clearCart()" class="bg-slate-800 text-gray-300 px-4 rounded-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Worker's Today Sales -->
        <div class="glass p-6 rounded-2xl">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-clipboard-list text-blue-400"></i>
                Today's Sales & Services
            </h3>
            <div id="worker-sales-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                <!-- Sales will appear here -->
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">Advanced Analytics Dashboard</h3>
                <button type="button" onclick="closeAnalytics()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass p-6 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-4">Revenue Trend (Last 7 Days)</h4>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="glass p-6 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-4">Sales by Category</h4>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                
                <div class="glass p-6 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-4">Top Selling Products</h4>
                    <div class="chart-container">
                        <canvas id="productsChart"></canvas>
                    </div>
                </div>
                
                <div class="glass p-6 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-4">Services Breakdown</h4>
                    <div class="chart-container">
                        <canvas id="servicesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reports-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">Business Reports</h3>
                <button type="button" onclick="closeReports()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="glass p-6 rounded-xl text-center cursor-pointer hover:bg-blue-900/30 transition" onclick="generateDailyReport()">
                    <i class="fas fa-calendar-day text-4xl text-blue-400 mb-3"></i>
                    <h4 class="font-semibold">Daily Report</h4>
                    <p class="text-sm text-gray-400">Today's summary</p>
                </div>
                <div class="glass p-6 rounded-xl text-center cursor-pointer hover:bg-green-900/30 transition" onclick="generateWeeklyReport()">
                    <i class="fas fa-calendar-week text-4xl text-green-400 mb-3"></i>
                    <h4 class="font-semibold">Weekly Report</h4>
                    <p class="text-sm text-gray-400">Last 7 days</p>
                </div>
                <div class="glass p-6 rounded-xl text-center cursor-pointer hover:bg-purple-900/30 transition" onclick="generateMonthlyReport()">
                    <i class="fas fa-calendar-alt text-4xl text-purple-400 mb-3"></i>
                    <h4 class="font-semibold">Monthly Report</h4>
                    <p class="text-sm text-gray-400">This month</p>
                </div>
            </div>
            
            <div id="report-output" class="hidden glass p-6 rounded-2xl">
                <!-- Report content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Services Modal (Admin) -->
    <div id="services-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">Services Summary</h3>
                <button type="button" onclick="closeServicesModal()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-green-900/20 rounded-xl">
                    <h4 class="font-semibold text-green-400">Easyload</h4>
                    <p class="text-2xl font-bold" id="admin-easyload-total">Rs. 0</p>
                </div>
                <div class="p-4 bg-purple-900/20 rounded-xl">
                    <h4 class="font-semibold text-purple-400">Print/Photocopy</h4>
                    <p class="text-2xl font-bold" id="admin-print-total">Rs. 0</p>
                </div>
                <div class="p-4 bg-blue-900/20 rounded-xl">
                    <h4 class="font-semibold text-blue-400">Forms</h4>
                    <p class="text-2xl font-bold" id="admin-forms-total">Rs. 0</p>
                </div>
            </div>
            
            <div id="services-detail-list" class="space-y-3">
                <!-- Service details will appear here -->
            </div>
        </div>
    </div>

    <!-- Worker Sales Modal (Admin) -->
    <div id="worker-sales-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">Worker Sales Report</h3>
                <button type="button" onclick="closeWorkerSales()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <select id="worker-select" class="bg-slate-900 border border-slate-700 p-3 rounded-lg w-full max-w-xs" onchange="showWorkerSalesReport()">
                    <option value="">Select Worker</option>
                </select>
            </div>
            
            <div id="worker-sales-report" class="space-y-3">
                <!-- Worker sales will appear here -->
            </div>
        </div>
    </div>

    <!-- Loans Modal -->
    <div id="loans-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">All Loans & Credits</h3>
                <button type="button" onclick="closeLoansModal()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4 flex gap-3">
                <button type="button" onclick="showActiveLoans()" class="bg-blue-900/30 text-blue-300 px-4 py-2 rounded-lg">Active Loans</button>
                <button type="button" onclick="showPaidLoans()" class="bg-green-900/30 text-green-300 px-4 py-2 rounded-lg">Paid Loans</button>
                <button type="button" onclick="showAllLoans()" class="bg-purple-900/30 text-purple-300 px-4 py-2 rounded-lg">All Loans</button>
            </div>
            
            <div id="all-loans-list" class="space-y-3">
                <!-- Loans will appear here -->
            </div>
        </div>
    </div>

    <!-- Password Manager Modal -->
    <div id="password-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-md mx-4">
            <h3 class="text-2xl font-bold gradient-text mb-6">Password Manager</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Admin Password</label>
                    <input type="password" id="admin-password-field" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Worker Password</label>
                    <input type="password" id="worker-password-field" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg">
                </div>
                <div class="p-4 bg-yellow-900/20 border border-yellow-700/30 rounded-lg">
                    <p class="text-sm text-yellow-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Default: adminmb123 / worker3214
                    </p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="savePasswords()" class="bg-green-900/30 text-green-300 px-4 py-2 rounded-lg hover:bg-green-900/50">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button type="button" onclick="closePasswordManager()" class="bg-slate-800 text-gray-300 px-4 py-2 rounded-lg hover:bg-slate-700">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 no-print">
                <h3 class="text-2xl font-bold gradient-text">Sales Invoice</h3>
                <div class="flex gap-2">
                    <button type="button" onclick="printInvoice()" class="bg-blue-900/30 text-blue-300 px-4 py-2 rounded-lg hover:bg-blue-900/50">
                        <i class="fas fa-print mr-2"></i>Print
                    </button>
                    <button type="button" onclick="closeInvoice()" class="text-gray-500 hover:text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div id="invoice-content" class="invoice-container">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backup-modal" class="modal">
        <div class="glass p-8 rounded-3xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text">Backup & Restore</h3>
                <button type="button" onclick="closeBackupModal()" class="text-gray-500 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-900/20 rounded-lg">
                    <h4 class="font-semibold mb-2">Create Backup</h4>
                    <p class="text-sm text-gray-400 mb-3">Download all data as JSON file</p>
                    <button type="button" onclick="createBackup()" class="w-full bg-blue-900/30 text-blue-300 py-2 rounded-lg hover:bg-blue-900/50">
                        <i class="fas fa-download mr-2"></i>Download Backup
                    </button>
                </div>
                
                <div class="p-4 bg-green-900/20 rounded-lg">
                    <h4 class="font-semibold mb-2">Restore Backup</h4>
                    <p class="text-sm text-gray-400 mb-3">Upload a backup file</p>
                    <input type="file" id="backup-file" class="w-full bg-slate-900 border border-slate-700 p-2 rounded-lg mb-3" accept=".json">
                    <button type="button" onclick="restoreBackup()" class="w-full bg-green-900/30 text-green-300 py-2 rounded-lg hover:bg-green-900/50">
                        <i class="fas fa-upload mr-2"></i>Restore
                    </button>
                </div>
                
                <div class="p-4 bg-red-900/20 rounded-lg">
                    <h4 class="font-semibold mb-2">Danger Zone</h4>
                    <p class="text-sm text-gray-400 mb-3">Reset all data</p>
                    <button type="button" onclick="resetAllData()" class="w-full bg-red-900/30 text-red-300 py-2 rounded-lg hover:bg-red-900/50">
                        <i class="fas fa-trash mr-2"></i>Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBUqqhPD6H9AaBKe_IvMeHfe07WLuEqkjQ",
            authDomain: "okasha-communication.firebaseapp.com",
            databaseURL: "https://okasha-communication-default-rtdb.firebaseio.com",
            projectId: "okasha-communication",
            storageBucket: "okasha-communication.firebasestorage.app",
            messagingSenderId: "458162168412",
            appId: "1:458162168412:web:d1d0fb735ba64691e23c99"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // ==================== GLOBAL VARIABLES ====================
        let products = [];
        let sales = [];
        let loans = [];
        let services = [];
        let activityLog = [];
        let currentUser = null;
        let currentRole = 'admin';
        let sessionStartTime = null;
        let sessionTimer = null;
        let workerSessionSales = [];
        let workerSessionServices = [];
        let cart = [];
        let charts = {};
        let isOnline = navigator.onLine;

        const SYSTEM_CONFIG = {
            defaultAdminPass: 'adminmb123',
            defaultWorkerPass: 'worker3214',
            deviceId: 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
        };

        const SHOP_DETAILS = {
            name: "OKASHA COMMUNICATION",
            address: "Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid",
            phone: "0311-5463213",
            bank: "Askari Bank - 00550350004927",
            easypaisa: "0311-5463213"
        };

        let systemPasswords = {
            admin: SYSTEM_CONFIG.defaultAdminPass,
            worker: SYSTEM_CONFIG.defaultWorkerPass
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log(" Complete Professional POS System Starting...");
            console.log("Version: 6.2 - INP Fixed");
            
            // Load data
            loadLocalData();
            loadFromFirebase();
            
            // Setup listeners
            setupListeners();
            
            // Start clocks
            updateClocks();
            setInterval(updateClocks, 1000);
            
            // Check session
            checkExistingSession();
            
            // Setup theme
            setupTheme();
            
            // Setup connection monitoring
            setupConnectionMonitoring();
            
            // Set up payment method change listener
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod) {
                paymentMethod.addEventListener('change', function() {
                    const loanDiv = document.getElementById('loan-customer-div');
                    const mobileDiv = document.getElementById('mobile-number-div');
                    
                    if (loanDiv) loanDiv.style.display = this.value === 'loan' ? 'block' : 'none';
                    if (mobileDiv) mobileDiv.style.display = (this.value === 'easypaisa' || this.value === 'jazzcash') ? 'block' : 'none';
                });
            }
        });

        // ==================== FIREBASE FUNCTIONS ====================
        function loadFromFirebase() {
            database.ref('products').on('value', (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.values(data) : [];
                console.log("Products loaded:", products.length);
                // Use requestAnimationFrame to prevent UI blocking
                requestAnimationFrame(() => {
                    updateAllDashboards();
                });
            });

            database.ref('sales').on('value', (snapshot) => {
                const data = snapshot.val();
                sales = data ? Object.values(data) : [];
                console.log("Sales loaded:", sales.length);
                requestAnimationFrame(() => {
                    updateAllDashboards();
                });
            });

            database.ref('loans').on('value', (snapshot) => {
                const data = snapshot.val();
                loans = data ? Object.values(data) : [];
                console.log("Loans loaded:", loans.length);
                requestAnimationFrame(() => {
                    updateLoansDisplay();
                });
            });

            database.ref('services').on('value', (snapshot) => {
                const data = snapshot.val();
                services = data ? Object.values(data) : [];
                console.log("Services loaded:", services.length);
                requestAnimationFrame(() => {
                    updateServicesDisplay();
                    updateWorkerDashboard();
                });
            });

            database.ref('activityLog').on('value', (snapshot) => {
                const data = snapshot.val();
                activityLog = data ? Object.values(data) : [];
                requestAnimationFrame(() => {
                    updateWorkerActivity();
                });
            });

            database.ref('passwords').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    systemPasswords = data;
                    localStorage.setItem('okasha_passwords', JSON.stringify(systemPasswords));
                }
            });
        }

        function saveToFirebase() {
            if (!isOnline) {
                saveLocalData();
                return;
            }

            try {
                const productsObj = {};
                products.forEach(p => productsObj[p.id] = p);
                database.ref('products').set(productsObj);

                const salesObj = {};
                sales.forEach(s => salesObj[s.id] = s);
                database.ref('sales').set(salesObj);

                const loansObj = {};
                loans.forEach(l => loansObj[l.id] = l);
                database.ref('loans').set(loansObj);

                const servicesObj = {};
                services.forEach(s => servicesObj[s.id] = s);
                database.ref('services').set(servicesObj);

                const activityObj = {};
                activityLog.forEach(a => activityObj[a.id] = a);
                database.ref('activityLog').set(activityObj);

                database.ref('passwords').set(systemPasswords);
                
                console.log("Data saved to Firebase");
                const now = new Date().toLocaleTimeString();
                document.getElementById('last-update') && (document.getElementById('last-update').textContent = `Updated: ${now}`);
                document.getElementById('worker-last-update') && (document.getElementById('worker-last-update').textContent = `Updated: ${now}`);
            } catch (error) {
                console.error("Firebase save error:", error);
                saveLocalData();
            }
        }

        // ==================== LOCAL STORAGE ====================
        function loadLocalData() {
            try {
                const savedProducts = localStorage.getItem('okasha_products');
                const savedSales = localStorage.getItem('okasha_sales');
                const savedLoans = localStorage.getItem('okasha_loans');
                const savedServices = localStorage.getItem('okasha_services');
                const savedActivity = localStorage.getItem('okasha_activity');
                const savedPasswords = localStorage.getItem('okasha_passwords');

                if (savedProducts && products.length === 0) products = JSON.parse(savedProducts);
                if (savedSales && sales.length === 0) sales = JSON.parse(savedSales);
                if (savedLoans && loans.length === 0) loans = JSON.parse(savedLoans);
                if (savedServices && services.length === 0) services = JSON.parse(savedServices);
                if (savedActivity && activityLog.length === 0) activityLog = JSON.parse(savedActivity);
                if (savedPasswords) systemPasswords = JSON.parse(savedPasswords);
            } catch(e) {
                console.error("Error loading local data:", e);
            }
        }

        function saveLocalData() {
            localStorage.setItem('okasha_products', JSON.stringify(products));
            localStorage.setItem('okasha_sales', JSON.stringify(sales));
            localStorage.setItem('okasha_loans', JSON.stringify(loans));
            localStorage.setItem('okasha_services', JSON.stringify(services));
            localStorage.setItem('okasha_activity', JSON.stringify(activityLog));
            localStorage.setItem('okasha_passwords', JSON.stringify(systemPasswords));
        }

        // ==================== CONNECTION MONITORING ====================
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                saveToFirebase();
                showNotification('Internet connected - Synced with cloud', 'success');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
                showNotification('You are offline. Using local storage.', 'warning');
            });
        }

        function updateConnectionStatus() {
            const el = document.getElementById('connection-status');
            if (el) {
                if (isOnline) {
                    el.className = 'connection-status online';
                    el.innerHTML = '<i class="fas fa-wifi"></i> <span>Internet Connected</span>';
                } else {
                    el.className = 'connection-status offline';
                    el.innerHTML = '<i class="fas fa-wifi-slash"></i> <span>Internet Offline</span>';
                }
            }
        }

        // ==================== LOGIN SYSTEM ====================
        function selectRole(role) {
            currentRole = role;
            const adminBtn = document.getElementById('btn-admin');
            const workerBtn = document.getElementById('btn-worker');
            const selectedRole = document.getElementById('selected-role');
            const roleDesc = document.getElementById('role-description');

            if (adminBtn && workerBtn) {
                adminBtn.className = role === 'admin' ? 
                    'flex-1 py-3 rounded-lg bg-blue-900/50 text-blue-300 font-medium border border-blue-700/50' :
                    'flex-1 py-3 rounded-lg bg-slate-800 text-slate-300 font-medium border border-slate-700';
                
                workerBtn.className = role === 'worker' ?
                    'flex-1 py-3 rounded-lg bg-blue-900/50 text-blue-300 font-medium border border-blue-700/50' :
                    'flex-1 py-3 rounded-lg bg-slate-800 text-slate-300 font-medium border border-slate-700';
            }

            if (selectedRole) selectedRole.textContent = role === 'admin' ? 'Admin' : 'Worker';
            if (roleDesc) roleDesc.textContent = role === 'admin' ? 
                'Full access to add products, view analytics, and manage system' :
                'Can process sales, easyload, print, forms and all services';
        }

        function handleLogin() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            if ((currentRole === 'admin' && password === systemPasswords.admin) ||
                (currentRole === 'worker' && password === systemPasswords.worker)) {
                
                if (errorDiv) errorDiv.classList.add('hidden');
                
                currentUser = {
                    role: currentRole,
                    name: currentRole === 'admin' ? 'Administrator' : 'Worker ' + Math.floor(Math.random() * 1000).toString().padStart(3, '0'),
                    loginTime: new Date(),
                    deviceId: SYSTEM_CONFIG.deviceId
                };

                sessionStartTime = new Date();
                startSessionTimer();
                saveSession();

                document.getElementById('login-screen').classList.add('hidden');
                
                if (currentRole === 'admin') {
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    updateAdminDashboard();
                } else {
                    document.getElementById('worker-dashboard').classList.remove('hidden');
                    workerSessionSales = [];
                    workerSessionServices = [];
                    updateWorkerDashboard();
                }

                logActivity('login', `${currentRole} logged in`);
                loadFromFirebase();
                showNotification(`Welcome ${currentUser.name}!`, 'success');
            } else {
                if (errorDiv) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = `Invalid ${currentRole} password`;
                }
                document.getElementById('password').classList.add('shake');
                setTimeout(() => document.getElementById('password').classList.remove('shake'), 500);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                if (sessionTimer) clearInterval(sessionTimer);
                logActivity('logout', `${currentRole} logged out`);
                clearSession();
                currentUser = null;
                cart = [];
                workerSessionSales = [];
                workerSessionServices = [];

                document.getElementById('admin-dashboard').classList.add('hidden');
                document.getElementById('worker-dashboard').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('password').value = '';
            }
        }

        function saveSession() {
            if (currentUser) {
                const session = {
                    user: currentUser,
                    loginTime: sessionStartTime,
                    expiry: Date.now() + (24 * 60 * 60 * 1000),
                    deviceId: SYSTEM_CONFIG.deviceId
                };
                localStorage.setItem('okasha_session', JSON.stringify(session));
            }
        }

        function clearSession() {
            localStorage.removeItem('okasha_session');
        }

        function checkExistingSession() {
            try {
                const sessionData = localStorage.getItem('okasha_session');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (Date.now() < session.expiry && session.deviceId === SYSTEM_CONFIG.deviceId) {
                        currentUser = session.user;
                        currentRole = session.user.role;
                        sessionStartTime = new Date(session.loginTime);
                        
                        document.getElementById('login-screen').classList.add('hidden');
                        
                        if (currentRole === 'admin') {
                            document.getElementById('admin-dashboard').classList.remove('hidden');
                            updateAdminDashboard();
                        } else {
                            document.getElementById('worker-dashboard').classList.remove('hidden');
                            updateWorkerDashboard();
                        }
                        
                        startSessionTimer();
                        showNotification(`Welcome back ${currentUser.name}!`, 'success');
                    } else {
                        localStorage.removeItem('okasha_session');
                    }
                }
            } catch(e) {
                console.error("Error checking session:", e);
            }
        }

        function startSessionTimer() {
            if (sessionTimer) clearInterval(sessionTimer);
            sessionTimer = setInterval(() => {
                if (sessionStartTime) {
                    const diff = Math.floor((new Date() - sessionStartTime) / 1000);
                    const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                    const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('admin-session-time') && (document.getElementById('admin-session-time').textContent = `${h}:${m}:${s}`);
                }
            }, 1000);
        }

        // ==================== CLOCK ====================
        function updateClocks() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });

            document.getElementById('admin-date') && (document.getElementById('admin-date').textContent = dateStr);
            document.getElementById('admin-time') && (document.getElementById('admin-time').textContent = timeStr);
            document.getElementById('worker-date') && (document.getElementById('worker-date').textContent = dateStr);
            document.getElementById('worker-time') && (document.getElementById('worker-time').textContent = timeStr);
        }

        // ==================== ADMIN FUNCTIONS ====================
        function increaseQuantity() {
            const input = document.getElementById('admin-quantity');
            input.value = parseInt(input.value) + 1;
        }

        function decreaseQuantity() {
            const input = document.getElementById('admin-quantity');
            if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('image-preview');
                    preview.querySelector('img').src = e.target.result;
                    preview.classList.remove('hidden');
                    showNotification('Image selected', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        async function addProductAdmin() {
            const name = document.getElementById('admin-product-name').value.trim();
            const barcode = document.getElementById('admin-barcode').value.trim() || `BAR${Date.now()}`;
            const category = document.getElementById('admin-category').value;
            const cost = parseFloat(document.getElementById('admin-cost-price').value) || 0;
            const price = parseFloat(document.getElementById('admin-sell-price').value) || 0;
            const quantity = parseInt(document.getElementById('admin-quantity').value) || 1;
            const imageFile = document.getElementById('product-image').files[0];

            if (!name) {
                showNotification('Please enter product name', 'warning');
                return;
            }

            if (price <= 0) {
                showNotification('Please enter valid selling price', 'warning');
                return;
            }

            showNotification('Uploading product...', 'info');

            let imageUrl = 'https://via.placeholder.com/100';
            if (imageFile) {
                try {
                    const storageRef = storage.ref(`products/${Date.now()}_${imageFile.name}`);
                    await storageRef.put(imageFile);
                    imageUrl = await storageRef.getDownloadURL();
                    showNotification('Image uploaded successfully', 'success');
                } catch(e) {
                    console.error("Image upload failed:", e);
                    showNotification('Image upload failed, using placeholder', 'warning');
                }
            }

            const product = {
                id: Date.now(),
                name: name,
                barcode: barcode,
                category: category,
                costPrice: cost,
                sellPrice: price,
                quantity: quantity,
                imageUrl: imageUrl,
                addedBy: currentUser?.name || 'Admin',
                date: new Date().toISOString()
            };

            products.push(product);
            saveToFirebase();
            saveLocalData();
            
            // Update UI
            requestAnimationFrame(() => {
                updateAdminDashboard();
            });

            // Clear form
            document.getElementById('admin-product-name').value = '';
            document.getElementById('admin-barcode').value = '';
            document.getElementById('admin-cost-price').value = '';
            document.getElementById('admin-sell-price').value = '';
            document.getElementById('admin-quantity').value = '1';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('product-image').value = '';

            logActivity('product_added', `Added ${name}`);
            showNotification(`"${name}" added successfully!`, 'success');
        }

        function updateAdminDashboard() {
            // Calculate stats
            const totalRevenue = sales.reduce((sum, s) => sum + (s.total || 0), 0);
            const totalProfit = calculateTotalProfit();
            const totalStock = products.reduce((sum, p) => sum + (p.quantity || 0), 0);
            
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => s.date && new Date(s.date).toDateString() === today);
            const todayRevenue = todaySales.reduce((sum, s) => sum + (s.total || 0), 0);
            const todayServices = services.filter(s => s.date && new Date(s.date).toDateString() === today).length;
            
            const activeLoans = loans.filter(l => !l.paid).reduce((sum, l) => sum + (l.amount || 0), 0);

            // Update stats
            document.getElementById('admin-revenue') && (document.getElementById('admin-revenue').textContent = totalRevenue.toLocaleString());
            document.getElementById('admin-profit') && (document.getElementById('admin-profit').textContent = totalProfit.toLocaleString());
            document.getElementById('admin-stock-count') && (document.getElementById('admin-stock-count').textContent = totalStock);
            document.getElementById('admin-today-sales') && (document.getElementById('admin-today-sales').textContent = todayRevenue.toLocaleString());
            document.getElementById('admin-loans') && (document.getElementById('admin-loans').textContent = activeLoans.toLocaleString());
            document.getElementById('admin-services') && (document.getElementById('admin-services').textContent = todayServices);

            // Update products list
            const container = document.getElementById('admin-products-list');
            if (!container) return;

            if (products.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No products added yet</div>';
                return;
            }

            let productsHtml = '';
            products.forEach(p => {
                const profitPerItem = (p.sellPrice || 0) - (p.costPrice || 0);
                let categoryClass = 'bg-gray-900/30 text-gray-300';
                if (p.category === 'mobile') categoryClass = 'bg-blue-900/30 text-blue-300';
                else if (p.category === 'accessory') categoryClass = 'bg-purple-900/30 text-purple-300';
                else if (p.category === 'repair') categoryClass = 'bg-yellow-900/30 text-yellow-300';
                else if (p.category === 'load') categoryClass = 'bg-green-900/30 text-green-300';
                else if (p.category === 'print') categoryClass = 'bg-indigo-900/30 text-indigo-300';
                else if (p.category === 'form') categoryClass = 'bg-pink-900/30 text-pink-300';

                productsHtml += `
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-lg">
                    <img src="${p.imageUrl}" class="product-image" onerror="this.src='https://via.placeholder.com/60'">
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h4 class="font-bold">${p.name}</h4>
                            <div class="flex gap-2">
                                <button onclick="editProduct(${p.id})" class="text-blue-400 hover:text-blue-300">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 text-sm mt-2">
                            <span class="text-gray-400">Stock: ${p.quantity || 0}</span>
                            <span class="text-gray-400">Cost: Rs.${p.costPrice || 0}</span>
                            <span class="text-green-400">Sell: Rs.${p.sellPrice || 0}</span>
                            <span class="${categoryClass} px-2 py-0.5 rounded-full text-xs">${p.category || 'other'}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Barcode: ${p.barcode || 'N/A'}</div>
                    </div>
                </div>
            `});

            container.innerHTML = productsHtml;

            // Update sales history
            const salesContainer = document.getElementById('admin-sales-history');
            if (salesContainer) {
                if (sales.length === 0) {
                    salesContainer.innerHTML = '<div class="text-center py-4 text-gray-400">No sales yet</div>';
                } else {
                    let salesHtml = '';
                    sales.slice(-10).reverse().forEach(s => {
                        salesHtml += `
                            <div class="p-3 bg-slate-800/30 rounded-lg">
                                <div class="flex justify-between">
                                    <span class="font-medium">${s.items?.length || 1} items</span>
                                    <span class="text-green-400 font-bold">Rs. ${s.total || 0}</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-400 mt-1">
                                    <span class="payment-badge payment-${s.paymentMethod || 'cash'}">${s.paymentMethod || 'cash'}</span>
                                    <span>${s.worker || 'Worker'}</span>
                                    <span>${s.date ? new Date(s.date).toLocaleTimeString() : ''}</span>
                                </div>
                            </div>
                        `;
                    });
                    salesContainer.innerHTML = salesHtml;
                }
            }

            // Setup search
            const searchInput = document.getElementById('admin-search');
            if (searchInput) {
                searchInput.oninput = function() {
                    const term = this.value.toLowerCase();
                    document.querySelectorAll('#admin-products-list > div').forEach(div => {
                        div.style.display = div.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
                    });
                };
            }
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const newName = prompt('Edit product name:', product.name);
            if (newName && newName.trim()) product.name = newName.trim();

            const newCost = prompt('Edit cost price:', product.costPrice);
            if (newCost && !isNaN(newCost)) product.costPrice = parseFloat(newCost);

            const newPrice = prompt('Edit selling price:', product.sellPrice);
            if (newPrice && !isNaN(newPrice)) product.sellPrice = parseFloat(newPrice);

            const newQty = prompt('Edit quantity:', product.quantity);
            if (newQty && !isNaN(newQty)) product.quantity = parseInt(newQty);

            saveToFirebase();
            saveLocalData();
            requestAnimationFrame(() => {
                updateAdminDashboard();
            });
            logActivity('product_updated', `Updated ${product.name}`);
            showNotification('Product updated', 'success');
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== id);
                saveToFirebase();
                saveLocalData();
                requestAnimationFrame(() => {
                    updateAdminDashboard();
                });
                logActivity('product_deleted', `Deleted product`);
                showNotification('Product deleted', 'success');
            }
        }

        function refreshAdmin() {
            requestAnimationFrame(() => {
                updateAdminDashboard();
            });
            showNotification('Dashboard refreshed', 'success');
        }

        // ==================== WORKER FUNCTIONS ====================
        function updateWorkerDashboard() {
            const availableProducts = products.filter(p => p.quantity > 0);
            
            // Update stats
            document.getElementById('worker-available-products') && 
                (document.getElementById('worker-available-products').textContent = availableProducts.length);
            
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => s.date && new Date(s.date).toDateString() === today && s.worker === currentUser?.name);
            const todayServices = services.filter(s => s.date && new Date(s.date).toDateString() === today && s.worker === currentUser?.name);
            
            const todayTotal = todaySales.reduce((sum, s) => sum + (s.total || 0), 0) + 
                              todayServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);
            const sessionTotal = workerSessionSales.reduce((sum, s) => sum + (s.total || 0), 0) + 
                                workerSessionServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);
            
            document.getElementById('worker-today-total') && 
                (document.getElementById('worker-today-total').textContent = `Rs. ${todayTotal.toLocaleString()}`);
            document.getElementById('worker-today-count') && 
                (document.getElementById('worker-today-count').textContent = todaySales.length + todayServices.length);
            document.getElementById('worker-session-total') && 
                (document.getElementById('worker-session-total').textContent = sessionTotal.toLocaleString());
            document.getElementById('worker-services-count') && 
                (document.getElementById('worker-services-count').textContent = todayServices.length);

            // Update products grid
            const container = document.getElementById('worker-products-grid');
            if (!container) return;

            if (availableProducts.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-400">No products available</div>';
                return;
            }

            let productsHtml = '';
            availableProducts.forEach(p => {
                let borderColor = 'border-green-500/30';
                if (p.category === 'load') borderColor = 'border-green-500';
                else if (p.category === 'print') borderColor = 'border-purple-500';
                else if (p.category === 'form') borderColor = 'border-blue-500';
                
                productsHtml += `
                <div class="bg-slate-800/50 rounded-xl p-3 cursor-pointer hover:bg-slate-800/70 transition blue-glow border-l-4 ${borderColor}" onclick="addToCart(${p.id})">
                    <img src="${p.imageUrl}" class="w-full h-24 object-cover rounded-lg mb-2" onerror="this.src='https://via.placeholder.com/100'">
                    <h4 class="font-bold text-sm">${p.name}</h4>
                    <p class="text-green-400 font-bold">Rs. ${p.sellPrice || 0}</p>
                    <p class="text-xs text-gray-400">Stock: ${p.quantity || 0}</p>
                    <span class="text-xs px-2 py-0.5 rounded-full ${p.category === 'load' ? 'bg-green-900/30 text-green-300' : p.category === 'print' ? 'bg-purple-900/30 text-purple-300' : p.category === 'form' ? 'bg-blue-900/30 text-blue-300' : 'bg-gray-900/30 text-gray-300'}">${p.category || 'other'}</span>
                </div>
            `});

            container.innerHTML = productsHtml;

            // Update sales list
            updateWorkerSalesList();

            // Setup search
            const searchInput = document.getElementById('worker-search');
            if (searchInput) {
                searchInput.oninput = function() {
                    const term = this.value.toLowerCase();
                    document.querySelectorAll('#worker-products-grid > div').forEach(div => {
                        div.style.display = div.textContent.toLowerCase().includes(term) ? 'block' : 'none';
                    });
                };
            }
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.quantity <= 0) {
                showNotification('Out of stock!', 'warning');
                return;
            }

            const existing = cart.find(item => item.id === productId);
            if (existing) {
                if (existing.quantity < product.quantity) {
                    existing.quantity++;
                } else {
                    showNotification('Not enough stock!', 'warning');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.sellPrice,
                    quantity: 1,
                    imageUrl: product.imageUrl,
                    category: product.category
                });
            }

            updateCartDisplay();
            showNotification(`${product.name} added to cart`, 'success');
        }

        function updateCartDisplay() {
            const container = document.getElementById('cart-items');
            const countEl = document.getElementById('cart-count');
            let subtotal = 0;

            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">Cart is empty</div>';
                countEl && (countEl.textContent = '0');
                document.getElementById('cart-subtotal').textContent = 'Rs. 0';
                document.getElementById('cart-total').textContent = 'Rs. 0';
                return;
            }

            let cartHtml = '';
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
                cartHtml += `
                    <div class="cart-item">
                        <img src="${item.imageUrl}" class="w-10 h-10 rounded object-cover" onerror="this.src='https://via.placeholder.com/40'">
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium">${item.name}</span>
                                <button onclick="removeFromCart(${item.id})" class="text-red-400 hover:text-red-300">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Rs.${item.price} x ${item.quantity}</span>
                                <span class="text-green-400">Rs.${item.price * item.quantity}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = cartHtml;

            countEl && (countEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0));
            document.getElementById('cart-subtotal').textContent = `Rs. ${subtotal}`;
            document.getElementById('cart-total').textContent = `Rs. ${subtotal}`;
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        function clearCart() {
            cart = [];
            updateCartDisplay();
            showNotification('Cart cleared', 'info');
        }

        function processSale() {
            if (cart.length === 0) {
                showNotification('Cart is empty!', 'warning');
                return;
            }

            const paymentMethod = document.getElementById('payment-method').value;
            const paymentRef = document.getElementById('payment-ref').value;
            const mobileNumber = document.getElementById('mobile-number')?.value || '';
            const customerName = document.getElementById('loan-customer')?.value || '';

            // Validate based on payment method
            if ((paymentMethod === 'easypaisa' || paymentMethod === 'jazzcash') && !mobileNumber) {
                showNotification('Please enter mobile number', 'warning');
                return;
            }

            if (paymentMethod === 'loan' && !customerName) {
                showNotification('Please enter customer name for loan', 'warning');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Update stock
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) product.quantity -= item.quantity;
            });

            // Create sale record
            const sale = {
                id: Date.now(),
                items: [...cart],
                total: total,
                paymentMethod: paymentMethod,
                paymentRef: paymentRef || null,
                mobileNumber: mobileNumber || null,
                customerName: customerName || null,
                worker: currentUser?.name || 'Worker',
                date: new Date().toISOString()
            };
            sales.push(sale);
            workerSessionSales.push(sale);

            // Handle loan
            if (paymentMethod === 'loan') {
                loans.push({
                    id: Date.now(),
                    customer: customerName,
                    amount: total,
                    items: [...cart],
                    date: new Date().toISOString(),
                    worker: currentUser?.name,
                    paid: false
                });
            }

            // Show invoice
            showInvoice(sale);

            saveToFirebase();
            saveLocalData();
            
            requestAnimationFrame(() => {
                updateWorkerDashboard();
            });
            
            clearCart();

            // Clear input fields
            document.getElementById('payment-ref').value = '';
            if (document.getElementById('mobile-number')) document.getElementById('mobile-number').value = '';
            if (document.getElementById('loan-customer')) document.getElementById('loan-customer').value = '';

            logActivity('sale', `Sold ${cart.length} items for Rs.${total} via ${paymentMethod}`, total);
        }

        // ==================== SERVICE FUNCTIONS - FIXED ====================
        function showServicePanel() {
            const modal = document.getElementById('service-panel-modal');
            if (modal) {
                modal.classList.add('active');
                console.log("Service panel opened");
            }
        }

        function closeServicePanel() {
            const modal = document.getElementById('service-panel-modal');
            if (modal) {
                modal.classList.remove('active');
                // Clear input fields
                if (document.getElementById('easyload-number')) document.getElementById('easyload-number').value = '';
                if (document.getElementById('easyload-amount')) document.getElementById('easyload-amount').value = '';
                if (document.getElementById('print-pages')) document.getElementById('print-pages').value = '';
                if (document.getElementById('print-price')) document.getElementById('print-price').value = '5';
                if (document.getElementById('form-customer')) document.getElementById('form-customer').value = '';
                if (document.getElementById('form-price')) document.getElementById('form-price').value = '';
            }
        }

        function processEasyload() {
            const number = document.getElementById('easyload-number')?.value;
            const amount = parseFloat(document.getElementById('easyload-amount')?.value);
            const company = document.getElementById('easyload-company')?.value;

            if (!number || !amount) {
                showNotification('Please enter mobile number and amount', 'warning');
                return;
            }

            if (amount <= 0) {
                showNotification('Please enter valid amount', 'warning');
                return;
            }

            const service = {
                id: Date.now(),
                type: 'easyload',
                number: number,
                amount: amount,
                company: company,
                worker: currentUser?.name,
                date: new Date().toISOString()
            };

            services.push(service);
            workerSessionServices.push(service);

            // Create a sale record for invoice
            const easyloadItem = {
                id: Date.now(),
                name: `Easyload - ${company} to ${number}`,
                price: amount,
                quantity: 1,
                total: amount
            };

            const sale = {
                id: Date.now(),
                items: [easyloadItem],
                total: amount,
                paymentMethod: 'load',
                worker: currentUser?.name,
                date: new Date().toISOString(),
                isService: true
            };
            sales.push(sale);
            workerSessionSales.push(sale);

            saveToFirebase();
            saveLocalData();
            
            requestAnimationFrame(() => {
                updateWorkerDashboard();
            });
            
            closeServicePanel();

            showInvoice(sale);
            showNotification(`Easyload of Rs.${amount} to ${number} processed`, 'success');
            logActivity('easyload', `Easyload Rs.${amount} to ${number}`, amount);
        }

        function processPrint() {
            const type = document.getElementById('print-type')?.value;
            const pages = parseInt(document.getElementById('print-pages')?.value);
            const pricePerPage = parseFloat(document.getElementById('print-price')?.value);

            if (!pages || pages <= 0) {
                showNotification('Please enter number of pages', 'warning');
                return;
            }

            if (!pricePerPage || pricePerPage <= 0) {
                showNotification('Please enter valid price per page', 'warning');
                return;
            }

            const total = pages * pricePerPage;

            const service = {
                id: Date.now(),
                type: 'print',
                serviceType: type,
                pages: pages,
                pricePerPage: pricePerPage,
                total: total,
                worker: currentUser?.name,
                date: new Date().toISOString()
            };

            services.push(service);
            workerSessionServices.push(service);

            // Get display name for print type
            let typeName = '';
            switch(type) {
                case 'print': typeName = 'Print (B&W)'; break;
                case 'print-color': typeName = 'Print (Color)'; break;
                case 'photocopy': typeName = 'Photocopy (B&W)'; break;
                case 'photocopy-color': typeName = 'Photocopy (Color)'; break;
                case 'scan': typeName = 'Scan'; break;
                default: typeName = 'Print Service';
            }

            // Create cart item for invoice
            const printItem = {
                id: Date.now(),
                name: `${typeName} - ${pages} pages @ Rs.${pricePerPage}`,
                price: pricePerPage,
                quantity: pages,
                total: total
            };

            const sale = {
                id: Date.now(),
                items: [printItem],
                total: total,
                paymentMethod: 'cash',
                worker: currentUser?.name,
                date: new Date().toISOString(),
                isService: true
            };
            sales.push(sale);
            workerSessionSales.push(sale);

            saveToFirebase();
            saveLocalData();
            
            requestAnimationFrame(() => {
                updateWorkerDashboard();
            });
            
            closeServicePanel();

            showInvoice(sale);
            showNotification(`Print/Photocopy processed - Rs.${total}`, 'success');
            logActivity('print', `Print service Rs.${total}`, total);
        }

        function processForm() {
            const formType = document.getElementById('form-type')?.value;
            const customer = document.getElementById('form-customer')?.value;
            const price = parseFloat(document.getElementById('form-price')?.value);

            if (!customer) {
                showNotification('Please enter customer name', 'warning');
                return;
            }

            if (!price || price <= 0) {
                showNotification('Please enter valid price', 'warning');
                return;
            }

            let formName = '';
            switch(formType) {
                case 'nadra': formName = 'Nadra Form'; break;
                case 'passport': formName = 'Passport Application'; break;
                case 'nic': formName = 'CNIC/B-Form'; break;
                case 'vehicle': formName = 'Vehicle Registration'; break;
                default: formName = 'Other Form';
            }

            const service = {
                id: Date.now(),
                type: 'form',
                formType: formName,
                customer: customer,
                price: price,
                worker: currentUser?.name,
                date: new Date().toISOString()
            };

            services.push(service);
            workerSessionServices.push(service);

            // Create cart item for invoice
            const formItem = {
                id: Date.now(),
                name: `${formName} - ${customer}`,
                price: price,
                quantity: 1,
                total: price
            };

            const sale = {
                id: Date.now(),
                items: [formItem],
                total: price,
                paymentMethod: 'cash',
                worker: currentUser?.name,
                date: new Date().toISOString(),
                isService: true
            };
            sales.push(sale);
            workerSessionSales.push(sale);

            saveToFirebase();
            saveLocalData();
            
            requestAnimationFrame(() => {
                updateWorkerDashboard();
            });
            
            closeServicePanel();

            showInvoice(sale);
            showNotification(`Form application for ${customer} - Rs.${price}`, 'success');
            logActivity('form', `Form for ${customer} Rs.${price}`, price);
        }

        function showInvoice(sale) {
            const modal = document.getElementById('invoice-modal');
            const content = document.getElementById('invoice-content');
            
            if (!modal || !content) return;

            const date = sale.date ? new Date(sale.date) : new Date();
            const items = sale.items || [{ name: 'Sale', quantity: 1, price: sale.total || 0 }];
            const totalQuantity = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
            const totalAmount = sale.total || items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);

            content.innerHTML = `
                <div class="invoice-header">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-3xl font-bold gradient-text">${SHOP_DETAILS.name}</h1>
                            <p class="text-gray-600">${SHOP_DETAILS.address}</p>
                            <p class="text-gray-500 text-sm">Tel: ${SHOP_DETAILS.phone}</p>
                            <p class="text-gray-500 text-sm">Easypaisa: ${SHOP_DETAILS.easypaisa}</p>
                            <p class="text-gray-500 text-sm">Bank: ${SHOP_DETAILS.bank}</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-blue-600">SALES INVOICE</h2>
                            <p class="text-gray-600">Date: ${date.toLocaleDateString()}</p>
                            <p class="text-gray-600">Time: ${date.toLocaleTimeString()}</p>
                            <p class="text-gray-600">Invoice #: INV-${sale.id.toString().slice(-6)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-gray-600">Cashier</p>
                            <p class="font-bold">${sale.worker || 'Worker'}</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-sm text-gray-600">Payment Method</p>
                            <p class="font-bold capitalize">${sale.paymentMethod || 'cash'}</p>
                        </div>
                    </div>
                    
                    ${sale.customerName ? `
                    <div class="p-3 bg-yellow-50 rounded-lg mb-4">
                        <p class="text-sm text-gray-600">Customer (Loan)</p>
                        <p class="font-bold">${sale.customerName}</p>
                    </div>` : ''}
                    
                    ${sale.mobileNumber ? `
                    <div class="p-3 bg-purple-50 rounded-lg mb-4">
                        <p class="text-sm text-gray-600">Mobile Number</p>
                        <p class="font-bold">${sale.mobileNumber}</p>
                    </div>` : ''}
                    
                    ${sale.paymentRef ? `
                    <div class="p-3 bg-gray-50 rounded-lg mb-4">
                        <p class="text-sm text-gray-600">Transaction Ref</p>
                        <p class="font-bold">${sale.paymentRef}</p>
                    </div>` : ''}
                </div>
                
                <h3 class="text-lg font-semibold mb-3">Sales Details</h3>
                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product/Service</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr>
                                <td class="text-center">${index + 1}</td>
                                <td>${item.name || 'Item'}</td>
                                <td class="text-center">${item.quantity || 1}</td>
                                <td class="text-right">Rs. ${(item.price || 0).toLocaleString()}</td>
                                <td class="text-right font-semibold">Rs. ${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="invoice-totals">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700">Total Items:</span>
                        <span class="font-semibold">${totalQuantity}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700">Subtotal:</span>
                        <span class="font-semibold">Rs. ${totalAmount.toLocaleString()}</span>
                    </div>
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold">GRAND TOTAL:</span>
                            <span class="text-2xl font-bold text-blue-600">Rs. ${totalAmount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t text-center text-sm text-gray-500">
                    <p>Thank you for your business!</p>
                    <p>Goods once sold will not be taken back</p>
                    <p class="text-xs mt-4">Liaq Ali Chowk Shop #5, Ahl e Adhees Masjid</p>
                    <p class="text-xs">Easypaisa: 0311-5463213 | Askari Bank: 00550350004927</p>
                </div>
            `;

            modal.classList.add('active');
        }

        function printInvoice() {
            window.print();
        }

        function closeInvoice() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        function scanBarcode() {
            document.getElementById('scanner-modal').classList.add('active');
        }

        function closeScanner() {
            document.getElementById('scanner-modal').classList.remove('active');
        }

        function searchByBarcode() {
            const barcode = document.getElementById('manual-barcode').value.trim();
            if (!barcode) {
                showNotification('Enter barcode', 'warning');
                return;
            }

            const product = products.find(p => p.barcode === barcode);
            
            if (product) {
                addToCart(product.id);
                closeScanner();
                document.getElementById('manual-barcode').value = '';
                showNotification(`Product found: ${product.name}`, 'success');
            } else {
                showNotification('Product not found!', 'warning');
            }
        }

        function updateWorkerSalesList() {
            const container = document.getElementById('worker-sales-list');
            if (!container) return;

            const allTransactions = [...workerSessionSales, ...workerSessionServices].sort((a, b) => {
                return new Date(b.date || 0) - new Date(a.date || 0);
            });

            if (allTransactions.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">No transactions in this session</div>';
                return;
            }

            let transactionsHtml = '';
            allTransactions.slice(0, 10).forEach(t => {
                if (t.items) {
                    // Sale transaction
                    transactionsHtml += `
                        <div class="p-3 bg-slate-800/30 rounded-lg">
                            <div class="flex justify-between">
                                <span class="font-medium">${t.items.length} items</span>
                                <span class="text-green-400 font-bold">Rs. ${t.total || 0}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-400 mt-1">
                                <span class="payment-badge payment-${t.paymentMethod || 'cash'}">${t.paymentMethod || 'cash'}</span>
                                <span>${t.date ? new Date(t.date).toLocaleTimeString() : ''}</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Service transaction
                    let serviceIcon = 'fa-mobile-alt';
                    let serviceColor = 'text-green-400';
                    if (t.type === 'print') { serviceIcon = 'fa-print'; serviceColor = 'text-purple-400'; }
                    else if (t.type === 'form') { serviceIcon = 'fa-file-alt'; serviceColor = 'text-blue-400'; }

                    transactionsHtml += `
                        <div class="p-3 bg-slate-800/30 rounded-lg">
                            <div class="flex justify-between">
                                <span class="font-medium flex items-center gap-2">
                                    <i class="fas ${serviceIcon} ${serviceColor}"></i>
                                    ${t.type === 'easyload' ? 'Easyload' : t.type === 'print' ? 'Print' : 'Form'}
                                </span>
                                <span class="text-green-400 font-bold">Rs. ${t.amount || t.total || t.price || 0}</span>
                            </div>
                            <div class="text-sm text-gray-400 mt-1">
                                <span>${t.date ? new Date(t.date).toLocaleTimeString() : ''}</span>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = transactionsHtml;
        }

        // Worker My Sales
        function showMySales() {
            const modal = document.getElementById('my-sales-modal');
            const container = document.getElementById('my-sales-list');
            
            if (!modal || !container) return;

            const workerSales = sales.filter(s => s.worker === currentUser?.name);
            const workerServices = services.filter(s => s.worker === currentUser?.name);
            const totalSales = workerSales.reduce((sum, s) => sum + (s.total || 0), 0);
            const totalServices = workerServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);
            
            if (workerSales.length === 0 && workerServices.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No transactions found</div>';
            } else {
                let salesHtml = `
                    <div class="p-4 bg-green-900/20 rounded-lg mb-4">
                        <h4 class="font-bold">Total Sales: Rs. ${(totalSales + totalServices).toLocaleString()}</h4>
                        <p class="text-sm text-gray-400">Products: ${workerSales.length} | Services: ${workerServices.length}</p>
                    </div>
                    
                    <h4 class="font-semibold mb-3">Recent Transactions</h4>
                `;

                const allTransactions = [...workerSales.slice(-10), ...workerServices.slice(-10)]
                    .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                    .slice(0, 10);

                allTransactions.forEach(t => {
                    if (t.items) {
                        salesHtml += `
                            <div class="p-3 bg-slate-800/30 rounded-lg mb-2">
                                <div class="flex justify-between">
                                    <span>${t.date ? new Date(t.date).toLocaleDateString() : ''}</span>
                                    <span class="text-green-400">Rs. ${t.total || 0}</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-400">
                                    <span>${t.items.length} items</span>
                                    <span class="payment-badge payment-${t.paymentMethod || 'cash'}">${t.paymentMethod || 'cash'}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        salesHtml += `
                            <div class="p-3 bg-slate-800/30 rounded-lg mb-2">
                                <div class="flex justify-between">
                                    <span>${t.date ? new Date(t.date).toLocaleDateString() : ''}</span>
                                    <span class="text-green-400">Rs. ${t.amount || t.total || t.price || 0}</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    <span class="service-badge service-${t.type || 'service'}">${t.type || 'service'}</span>
                                </div>
                            </div>
                        `;
                    }
                });

                container.innerHTML = salesHtml;
            }

            modal.classList.add('active');
        }

        function closeMySales() {
            document.getElementById('my-sales-modal').classList.remove('active');
        }

        // Generate Daily Invoice
        function generateDailyInvoice() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => s.date && new Date(s.date).toDateString() === today && s.worker === currentUser?.name);
            const todayServices = services.filter(s => s.date && new Date(s.date).toDateString() === today && s.worker === currentUser?.name);

            if (todaySales.length === 0 && todayServices.length === 0) {
                showNotification('No transactions today', 'warning');
                return;
            }

            // Create items array
            const items = [];
            todaySales.forEach(s => items.push(...(s.items || [{ name: 'Sale', quantity: 1, price: s.total || 0 }])));
            todayServices.forEach(s => {
                if (s.type === 'easyload') {
                    items.push({ name: `Easyload - ${s.number || ''}`, quantity: 1, price: s.amount || 0 });
                } else if (s.type === 'print') {
                    items.push({ name: `${s.serviceType || 'Print'} - ${s.pages || 0} pages`, quantity: 1, price: s.total || 0 });
                } else if (s.type === 'form') {
                    items.push({ name: `${s.formType || 'Form'} - ${s.customer || ''}`, quantity: 1, price: s.price || 0 });
                }
            });

            const total = items.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);

            const combinedSale = {
                id: Date.now(),
                items: items,
                total: total,
                paymentMethod: 'multiple',
                worker: currentUser?.name,
                date: new Date().toISOString()
            };

            showInvoice(combinedSale);
        }

        // ==================== SERVICES ADMIN ====================
        function showServices() {
            const modal = document.getElementById('services-modal');
            const detailList = document.getElementById('services-detail-list');
            
            if (!modal || !detailList) return;

            const today = new Date().toDateString();
            const todayServices = services.filter(s => s.date && new Date(s.date).toDateString() === today);
            
            const easyloadTotal = todayServices.filter(s => s.type === 'easyload').reduce((sum, s) => sum + (s.amount || 0), 0);
            const printTotal = todayServices.filter(s => s.type === 'print').reduce((sum, s) => sum + (s.total || 0), 0);
            const formsTotal = todayServices.filter(s => s.type === 'form').reduce((sum, s) => sum + (s.price || 0), 0);

            document.getElementById('admin-easyload-total') && (document.getElementById('admin-easyload-total').textContent = `Rs. ${easyloadTotal.toLocaleString()}`);
            document.getElementById('admin-print-total') && (document.getElementById('admin-print-total').textContent = `Rs. ${printTotal.toLocaleString()}`);
            document.getElementById('admin-forms-total') && (document.getElementById('admin-forms-total').textContent = `Rs. ${formsTotal.toLocaleString()}`);

            if (todayServices.length === 0) {
                detailList.innerHTML = '<div class="text-center py-4 text-gray-400">No services today</div>';
            } else {
                let servicesHtml = '';
                todayServices.slice(-10).reverse().forEach(s => {
                    servicesHtml += `
                        <div class="p-3 bg-slate-800/30 rounded-lg">
                            <div class="flex justify-between">
                                <span class="font-medium flex items-center gap-2">
                                    <i class="fas ${s.type === 'easyload' ? 'fa-mobile-alt' : s.type === 'print' ? 'fa-print' : 'fa-file-alt'} 
                                        ${s.type === 'easyload' ? 'text-green-400' : s.type === 'print' ? 'text-purple-400' : 'text-blue-400'}"></i>
                                    ${s.type === 'easyload' ? 'Easyload' : s.type === 'print' ? 'Print/Photocopy' : 'Form'}
                                </span>
                                <span class="text-green-400">Rs. ${s.amount || s.total || s.price || 0}</span>
                            </div>
                            <div class="text-sm text-gray-400 mt-1">
                                <span>Worker: ${s.worker || 'Unknown'}</span>
                                <span class="ml-4">${s.date ? new Date(s.date).toLocaleTimeString() : ''}</span>
                            </div>
                            ${s.number ? `<p class="text-xs text-gray-500">Mobile: ${s.number}</p>` : ''}
                            ${s.customer ? `<p class="text-xs text-gray-500">Customer: ${s.customer}</p>` : ''}
                        </div>
                    `;
                });
                detailList.innerHTML = servicesHtml;
            }

            modal.classList.add('active');
        }

        function closeServicesModal() {
            document.getElementById('services-modal').classList.remove('active');
        }

        function updateServicesDisplay() {
            const container = document.getElementById('services-list');
            if (!container) return;

            const recentServices = services.slice(-5).reverse();
            
            if (recentServices.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">No services yet</div>';
                return;
            }

            let servicesHtml = '';
            recentServices.forEach(s => {
                servicesHtml += `
                    <div class="p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex justify-between">
                            <span class="font-medium flex items-center gap-2">
                                <i class="fas ${s.type === 'easyload' ? 'fa-mobile-alt' : s.type === 'print' ? 'fa-print' : 'fa-file-alt'} 
                                    ${s.type === 'easyload' ? 'text-green-400' : s.type === 'print' ? 'text-purple-400' : 'text-blue-400'}"></i>
                                ${s.type || 'service'}
                            </span>
                            <span class="text-green-400">Rs. ${s.amount || s.total || s.price || 0}</span>
                        </div>
                        <p class="text-xs text-gray-400">${s.date ? new Date(s.date).toLocaleTimeString() : ''} - ${s.worker || 'Unknown'}</p>
                    </div>
                `;
            });

            container.innerHTML = servicesHtml;
        }

        // ==================== LOANS FUNCTIONS ====================
        function showLoans() {
            const modal = document.getElementById('loans-modal');
            if (!modal) return;
            modal.classList.add('active');
            showActiveLoans();
        }

        function showActiveLoans() {
            const container = document.getElementById('all-loans-list');
            if (!container) return;

            const activeLoans = loans.filter(l => !l.paid);
            
            if (activeLoans.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No active loans</div>';
                return;
            }

            let loansHtml = '';
            activeLoans.forEach(loan => {
                loansHtml += `
                    <div class="p-4 bg-slate-800/50 rounded-lg">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-bold text-lg">${loan.customer || 'Unknown'}</h4>
                            <span class="text-red-400 text-xl font-bold">Rs. ${loan.amount || 0}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-400 mb-3">
                            <p>Date: ${loan.date ? new Date(loan.date).toLocaleDateString() : ''}</p>
                            <p>Worker: ${loan.worker || 'Unknown'}</p>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">Items: ${loan.items ? loan.items.map(i => i.name).join(', ') : 'N/A'}</p>
                        <button onclick="markLoanPaid(${loan.id})" class="bg-green-900/30 text-green-300 px-4 py-2 rounded-lg text-sm hover:bg-green-900/50">
                            <i class="fas fa-check mr-2"></i>Mark as Paid
                        </button>
                    </div>
                `;
            });

            container.innerHTML = loansHtml;
        }

        function showPaidLoans() {
            const container = document.getElementById('all-loans-list');
            if (!container) return;

            const paidLoans = loans.filter(l => l.paid);
            
            if (paidLoans.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No paid loans</div>';
                return;
            }

            let loansHtml = '';
            paidLoans.forEach(loan => {
                loansHtml += `
                    <div class="p-4 bg-slate-800/30 rounded-lg opacity-75">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-bold">${loan.customer || 'Unknown'}</h4>
                            <span class="text-green-400">Rs. ${loan.amount || 0} (Paid)</span>
                        </div>
                        <p class="text-sm text-gray-400">Date: ${loan.date ? new Date(loan.date).toLocaleDateString() : ''}</p>
                    </div>
                `;
            });

            container.innerHTML = loansHtml;
        }

        function showAllLoans() {
            const container = document.getElementById('all-loans-list');
            if (!container) return;

            if (loans.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No loans</div>';
                return;
            }

            let loansHtml = '';
            loans.forEach(loan => {
                loansHtml += `
                    <div class="p-4 ${loan.paid ? 'bg-slate-800/30' : 'bg-slate-800/50'} rounded-lg">
                        <div class="flex justify-between mb-2">
                            <h4 class="font-bold">${loan.customer || 'Unknown'}</h4>
                            <span class="${loan.paid ? 'text-green-400' : 'text-red-400'}">Rs. ${loan.amount || 0} ${loan.paid ? '(Paid)' : ''}</span>
                        </div>
                        <p class="text-sm text-gray-400">Date: ${loan.date ? new Date(loan.date).toLocaleDateString() : ''}</p>
                    </div>
                `;
            });

            container.innerHTML = loansHtml;
        }

        function markLoanPaid(loanId) {
            loans = loans.map(l => l.id === loanId ? {...l, paid: true} : l);
            saveToFirebase();
            saveLocalData();
            showActiveLoans();
            updateAdminDashboard();
            showNotification('Loan marked as paid', 'success');
        }

        function closeLoansModal() {
            document.getElementById('loans-modal').classList.remove('active');
        }

        function updateLoansDisplay() {
            const container = document.getElementById('loans-list');
            if (!container) return;

            const activeLoans = loans.filter(l => !l.paid).slice(0, 5);
            
            if (activeLoans.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">No active loans</div>';
                return;
            }

            let loansHtml = '';
            activeLoans.forEach(loan => {
                loansHtml += `
                    <div class="p-3 bg-slate-800/30 rounded-lg">
                        <div class="flex justify-between">
                            <span class="font-medium">${loan.customer || 'Unknown'}</span>
                            <span class="text-red-400">Rs. ${loan.amount || 0}</span>
                        </div>
                        <p class="text-xs text-gray-400">${loan.date ? new Date(loan.date).toLocaleDateString() : ''}</p>
                    </div>
                `;
            });

            container.innerHTML = loansHtml;
        }

        // ==================== WORKER SALES REPORT (ADMIN) ====================
        function showWorkerSales() {
            const modal = document.getElementById('worker-sales-modal');
            const select = document.getElementById('worker-select');
            
            if (!modal || !select) return;

            // Get unique workers
            const workers = [...new Set([...sales.map(s => s.worker), ...services.map(s => s.worker)].filter(w => w))];
            
            let options = '<option value="">Select Worker</option>';
            workers.forEach(w => {
                options += `<option value="${w}">${w}</option>`;
            });
            select.innerHTML = options;

            modal.classList.add('active');
        }

        function showWorkerSalesReport() {
            const worker = document.getElementById('worker-select').value;
            const container = document.getElementById('worker-sales-report');
            
            if (!worker || !container) return;

            const workerSales = sales.filter(s => s.worker === worker);
            const workerServices = services.filter(s => s.worker === worker);
            const totalSales = workerSales.reduce((sum, s) => sum + (s.total || 0), 0);
            const totalServices = workerServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);

            let reportHtml = `
                <div class="p-4 bg-green-900/20 rounded-lg mb-4">
                    <h4 class="font-bold text-xl">${worker}</h4>
                    <p class="text-sm text-gray-400">Total Sales: Rs. ${(totalSales + totalServices).toLocaleString()}</p>
                    <p class="text-sm text-gray-400">Products: ${workerSales.length} | Services: ${workerServices.length}</p>
                </div>
                
                <h4 class="font-semibold mb-3">Recent Activity</h4>
            `;

            const allTransactions = [...workerSales.slice(-5), ...workerServices.slice(-5)]
                .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                .slice(0, 10);

            allTransactions.forEach(t => {
                if (t.items) {
                    reportHtml += `
                        <div class="p-3 bg-slate-800/30 rounded-lg mb-2">
                            <div class="flex justify-between">
                                <span>${t.date ? new Date(t.date).toLocaleDateString() : ''}</span>
                                <span class="text-green-400">Rs. ${t.total || 0}</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>${t.items.length} items - ${t.paymentMethod || 'cash'}</span>
                            </div>
                        </div>
                    `;
                } else {
                    reportHtml += `
                        <div class="p-3 bg-slate-800/30 rounded-lg mb-2">
                            <div class="flex justify-between">
                                <span>${t.date ? new Date(t.date).toLocaleDateString() : ''}</span>
                                <span class="text-green-400">Rs. ${t.amount || t.total || t.price || 0}</span>
                            </div>
                            <div class="text-sm text-gray-400">
                                <span>${t.type || 'service'} service</span>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = reportHtml;
        }

        function closeWorkerSales() {
            document.getElementById('worker-sales-modal').classList.remove('active');
        }

        // ==================== REPORTS ====================
        function showReports() {
            document.getElementById('reports-modal').classList.add('active');
        }

        function closeReports() {
            document.getElementById('reports-modal').classList.remove('active');
            document.getElementById('report-output').classList.add('hidden');
        }

        function generateDailyReport() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => s.date && new Date(s.date).toDateString() === today);
            const todayServices = services.filter(s => s.date && new Date(s.date).toDateString() === today);
            
            const total = todaySales.reduce((sum, s) => sum + (s.total || 0), 0) + 
                         todayServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);
            
            const byMethod = {
                cash: todaySales.filter(s => s.paymentMethod === 'cash').reduce((sum, s) => sum + (s.total || 0), 0),
                easypaisa: todaySales.filter(s => s.paymentMethod === 'easypaisa').reduce((sum, s) => sum + (s.total || 0), 0),
                jazzcash: todaySales.filter(s => s.paymentMethod === 'jazzcash').reduce((sum, s) => sum + (s.total || 0), 0),
                loan: todaySales.filter(s => s.paymentMethod === 'loan').reduce((sum, s) => sum + (s.total || 0), 0),
                bank: todaySales.filter(s => s.paymentMethod === 'bank').reduce((sum, s) => sum + (s.total || 0), 0)
            };

            const output = document.getElementById('report-output');
            output.innerHTML = `
                <h3 class="font-bold text-xl mb-4 gradient-text">Daily Report - ${new Date().toLocaleDateString()}</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-blue-900/20 rounded-xl">
                        <p class="text-sm text-blue-300">Total Sales</p>
                        <h4 class="text-2xl font-bold">Rs. ${total.toLocaleString()}</h4>
                    </div>
                    <div class="p-4 bg-green-900/20 rounded-xl">
                        <p class="text-sm text-green-300">Products</p>
                        <h4 class="text-2xl font-bold">${todaySales.length}</h4>
                    </div>
                    <div class="p-4 bg-purple-900/20 rounded-xl">
                        <p class="text-sm text-purple-300">Services</p>
                        <h4 class="text-2xl font-bold">${todayServices.length}</h4>
                    </div>
                    <div class="p-4 bg-yellow-900/20 rounded-xl">
                        <p class="text-sm text-yellow-300">Items Sold</p>
                        <h4 class="text-2xl font-bold">${todaySales.reduce((sum, s) => sum + (s.items?.length || 1), 0)}</h4>
                    </div>
                </div>
                
                <h4 class="font-semibold mb-3">Payment Methods</h4>
                <div class="space-y-2 mb-6">
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Cash</span>
                        <span class="font-bold text-green-400">Rs. ${byMethod.cash.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Easypaisa</span>
                        <span class="font-bold text-blue-400">Rs. ${byMethod.easypaisa.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>JazzCash</span>
                        <span class="font-bold text-purple-400">Rs. ${byMethod.jazzcash.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Bank Transfer</span>
                        <span class="font-bold text-teal-400">Rs. ${byMethod.bank.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Loan</span>
                        <span class="font-bold text-red-400">Rs. ${byMethod.loan.toLocaleString()}</span>
                    </div>
                </div>
                
                <h4 class="font-semibold mb-3">Services Breakdown</h4>
                <div class="space-y-2">
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Easyload</span>
                        <span class="font-bold text-green-400">Rs. ${todayServices.filter(s => s.type === 'easyload').reduce((sum, s) => sum + (s.amount || 0), 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Print/Photocopy</span>
                        <span class="font-bold text-purple-400">Rs. ${todayServices.filter(s => s.type === 'print').reduce((sum, s) => sum + (s.total || 0), 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between p-2 bg-slate-800/30 rounded">
                        <span>Forms</span>
                        <span class="font-bold text-blue-400">Rs. ${todayServices.filter(s => s.type === 'form').reduce((sum, s) => sum + (s.price || 0), 0).toLocaleString()}</span>
                    </div>
                </div>
            `;
            output.classList.remove('hidden');
        }

        function generateWeeklyReport() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekSales = sales.filter(s => s.date && new Date(s.date) >= weekAgo);
            const weekServices = services.filter(s => s.date && new Date(s.date) >= weekAgo);
            const total = weekSales.reduce((sum, s) => sum + (s.total || 0), 0) + 
                         weekServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);

            const output = document.getElementById('report-output');
            output.innerHTML = `
                <h3 class="font-bold text-xl mb-4 gradient-text">Weekly Report (Last 7 Days)</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-blue-900/20 rounded-xl">
                        <p class="text-sm text-blue-300">Total Revenue</p>
                        <h4 class="text-2xl font-bold">Rs. ${total.toLocaleString()}</h4>
                    </div>
                    <div class="p-4 bg-green-900/20 rounded-xl">
                        <p class="text-sm text-green-300">Transactions</p>
                        <h4 class="text-2xl font-bold">${weekSales.length + weekServices.length}</h4>
                    </div>
                </div>
                <p class="text-gray-400">Daily Average: Rs. ${Math.round(total / 7).toLocaleString()}</p>
            `;
            output.classList.remove('hidden');
        }

        function generateMonthlyReport() {
            const monthStart = new Date();
            monthStart.setDate(1);
            monthStart.setHours(0, 0, 0, 0);
            const monthSales = sales.filter(s => s.date && new Date(s.date) >= monthStart);
            const monthServices = services.filter(s => s.date && new Date(s.date) >= monthStart);
            const total = monthSales.reduce((sum, s) => sum + (s.total || 0), 0) + 
                         monthServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);

            const output = document.getElementById('report-output');
            output.innerHTML = `
                <h3 class="font-bold text-xl mb-4 gradient-text">Monthly Report - ${new Date().toLocaleDateString('default', { month: 'long', year: 'numeric' })}</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-blue-900/20 rounded-xl">
                        <p class="text-sm text-blue-300">Total Revenue</p>
                        <h4 class="text-2xl font-bold">Rs. ${total.toLocaleString()}</h4>
                    </div>
                    <div class="p-4 bg-green-900/20 rounded-xl">
                        <p class="text-sm text-green-300">Transactions</p>
                        <h4 class="text-2xl font-bold">${monthSales.length + monthServices.length}</h4>
                    </div>
                </div>
                <p class="text-gray-400">Daily Average: Rs. ${Math.round(total / new Date().getDate()).toLocaleString()}</p>
            `;
            output.classList.remove('hidden');
        }

        // ==================== ANALYTICS ====================
        function showAnalytics() {
            const modal = document.getElementById('analytics-modal');
            modal.classList.add('active');
            setTimeout(initializeCharts, 100);
        }

        function closeAnalytics() {
            document.getElementById('analytics-modal').classList.remove('active');
            Object.values(charts).forEach(c => c?.destroy());
            charts = {};
        }

        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                if (charts.revenueChart) charts.revenueChart.destroy();
                
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const data = days.map((_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (6 - i));
                    const daySales = sales.filter(s => s.date && new Date(s.date).toDateString() === date.toDateString());
                    const dayServices = services.filter(s => s.date && new Date(s.date).toDateString() === date.toDateString());
                    const serviceTotal = dayServices.reduce((sum, s) => sum + (s.amount || s.total || s.price || 0), 0);
                    return daySales.reduce((sum, s) => sum + (s.total || 0), 0) + serviceTotal;
                });

                charts.revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: days,
                        datasets: [{
                            label: 'Revenue (Rs.)',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' } }
                        },
                        scales: {
                            y: { 
                                ticks: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: { 
                                ticks: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                if (charts.categoryChart) charts.categoryChart.destroy();

                const categories = {};
                products.forEach(p => categories[p.category || 'other'] = (categories[p.category || 'other'] || 0) + (p.quantity || 0));

                charts.categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories).map(c => c.toUpperCase()),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#14b8a6'],
                            borderWidth: 2,
                            borderColor: document.body.classList.contains('light-mode') ? '#ffffff' : '#0f172a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' }
                            }
                        }
                    }
                });
            }

            // Products Chart
            const productsCtx = document.getElementById('productsChart');
            if (productsCtx) {
                if (charts.productsChart) charts.productsChart.destroy();

                const productSales = {};
                sales.forEach(s => {
                    if (s.items) {
                        s.items.forEach(item => {
                            productSales[item.name || 'item'] = (productSales[item.name || 'item'] || 0) + (item.quantity || 1);
                        });
                    }
                });

                const topProducts = Object.entries(productSales)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                charts.productsChart = new Chart(productsCtx, {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(p => p[0].substring(0, 15) + (p[0].length > 15 ? '...' : '')),
                        datasets: [{
                            label: 'Quantity Sold',
                            data: topProducts.map(p => p[1]),
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' } }
                        },
                        scales: {
                            y: { 
                                ticks: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            x: { 
                                ticks: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // Services Chart
            const servicesCtx = document.getElementById('servicesChart');
            if (servicesCtx) {
                if (charts.servicesChart) charts.servicesChart.destroy();

                const serviceTypes = { easyload: 0, print: 0, form: 0 };
                services.forEach(s => {
                    if (s.type === 'easyload') serviceTypes.easyload += s.amount || 0;
                    else if (s.type === 'print') serviceTypes.print += s.total || 0;
                    else if (s.type === 'form') serviceTypes.form += s.price || 0;
                });

                charts.servicesChart = new Chart(servicesCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Easyload', 'Print/Photocopy', 'Forms'],
                        datasets: [{
                            data: Object.values(serviceTypes),
                            backgroundColor: ['#10b981', '#8b5cf6', '#3b82f6'],
                            borderWidth: 2,
                            borderColor: document.body.classList.contains('light-mode') ? '#ffffff' : '#0f172a'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { color: document.body.classList.contains('light-mode') ? '#1e293b' : '#f1f5f9' }
                            }
                        }
                    }
                });
            }
        }

        // ==================== ACTIVITY ====================
        function updateWorkerActivity() {
            const container = document.getElementById('worker-activity');
            if (!container) return;

            const recent = activityLog.slice(-10).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">No recent activity</div>';
                return;
            }

            let activityHtml = '';
            recent.forEach(a => {
                let icon = 'fa-info-circle';
                let color = 'text-blue-400';
                
                if (a.type === 'sale') { icon = 'fa-shopping-cart'; color = 'text-green-400'; }
                else if (a.type === 'easyload') { icon = 'fa-mobile-alt'; color = 'text-green-400'; }
                else if (a.type === 'print') { icon = 'fa-print'; color = 'text-purple-400'; }
                else if (a.type === 'form') { icon = 'fa-file-alt'; color = 'text-blue-400'; }
                else if (a.type === 'product_added') { icon = 'fa-plus-circle'; color = 'text-purple-400'; }
                else if (a.type === 'login') { icon = 'fa-sign-in-alt'; color = 'text-green-400'; }
                else if (a.type === 'logout') { icon = 'fa-sign-out-alt'; color = 'text-red-400'; }

                activityHtml += `
                    <div class="p-2 bg-slate-800/30 rounded-lg text-sm flex items-center gap-3">
                        <div class="w-6 h-6 rounded-full ${color} bg-opacity-20 flex items-center justify-center">
                            <i class="fas ${icon} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p>${a.message || ''}</p>
                            <p class="text-xs text-gray-400">${a.timestamp ? new Date(a.timestamp).toLocaleTimeString() : ''}</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = activityHtml;
        }

        function logActivity(type, message, amount = null) {
            const activity = {
                id: Date.now(),
                type: type,
                message: message,
                amount: amount,
                timestamp: new Date().toISOString(),
                user: currentUser?.name || 'System',
                deviceId: SYSTEM_CONFIG.deviceId
            };
            activityLog.push(activity);
            if (activityLog.length > 100) activityLog = activityLog.slice(-100);
            saveToFirebase();
        }

        // ==================== PASSWORD MANAGER ====================
        function showPasswordManager() {
            document.getElementById('admin-password-field').value = systemPasswords.admin;
            document.getElementById('worker-password-field').value = systemPasswords.worker;
            document.getElementById('password-modal').classList.add('active');
        }

        function closePasswordManager() {
            document.getElementById('password-modal').classList.remove('active');
        }

        function savePasswords() {
            const adminPass = document.getElementById('admin-password-field').value;
            const workerPass = document.getElementById('worker-password-field').value;

            if (adminPass.length < 4 || workerPass.length < 4) {
                showNotification('Password must be at least 4 characters', 'warning');
                return;
            }

            systemPasswords = { admin: adminPass, worker: workerPass };
            localStorage.setItem('okasha_passwords', JSON.stringify(systemPasswords));
            saveToFirebase();
            closePasswordManager();
            showNotification('Passwords updated!', 'success');
        }

        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.getElementById('password-toggle');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // ==================== BACKUP ====================
        function backupData() {
            document.getElementById('backup-modal').classList.add('active');
        }

        function closeBackupModal() {
            document.getElementById('backup-modal').classList.remove('active');
        }

        function createBackup() {
            const data = {
                products: products,
                sales: sales,
                loans: loans,
                services: services,
                activityLog: activityLog,
                systemPasswords: systemPasswords,
                date: new Date().toISOString(),
                version: '6.2',
                shop: SHOP_DETAILS
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = `okasha_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Backup created', 'success');
            logActivity('backup', 'Created backup');
        }

        function restoreBackup() {
            const file = document.getElementById('backup-file').files[0];
            if (!file) {
                showNotification('Select a file', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Restore backup? Current data will be replaced.')) {
                        products = data.products || [];
                        sales = data.sales || [];
                        loans = data.loans || [];
                        services = data.services || [];
                        activityLog = data.activityLog || [];
                        if (data.systemPasswords) systemPasswords = data.systemPasswords;
                        
                        saveToFirebase();
                        saveLocalData();
                        requestAnimationFrame(() => {
                            updateAllDashboards();
                        });
                        closeBackupModal();
                        showNotification('Backup restored!', 'success');
                        logActivity('restore', 'Restored from backup');
                    }
                } catch(err) {
                    showNotification('Invalid backup file', 'warning');
                }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm(' WARNING: This will DELETE ALL DATA!\n\nAre you absolutely sure?')) {
                products = [];
                sales = [];
                loans = [];
                services = [];
                activityLog = [];
                workerSessionSales = [];
                workerSessionServices = [];
                cart = [];
                systemPasswords = {
                    admin: SYSTEM_CONFIG.defaultAdminPass,
                    worker: SYSTEM_CONFIG.defaultWorkerPass
                };
                
                saveToFirebase();
                saveLocalData();
                requestAnimationFrame(() => {
                    updateAllDashboards();
                });
                closeBackupModal();
                showNotification('All data reset', 'warning');
                logActivity('reset', 'Reset all data');
            }
        }

        // ==================== UTILITY ====================
        function calculateTotalProfit() {
            return sales.reduce((sum, s) => {
                if (s.items) {
                    return sum + s.items.reduce((itemSum, item) => {
                        const product = products.find(p => p.id === item.id);
                        return itemSum + (product ? ((item.price || 0) - (product.costPrice || 0)) * (item.quantity || 1) : (item.price || 0) * 0.3);
                    }, 0);
                }
                return sum + (s.total || 0) * 0.3;
            }, 0);
        }

        function showNotification(message, type = 'info') {
            // Use setTimeout to prevent UI blocking
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg z-50 animate-fadeIn ${
                    type === 'success' ? 'bg-green-900/90 text-green-100' : 
                    type === 'warning' ? 'bg-yellow-900/90 text-yellow-100' : 
                    'bg-blue-900/90 text-blue-100'
                }`;
                notification.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }, 10);
        }

        function updateAllDashboards() {
            if (currentRole === 'admin' && !document.getElementById('admin-dashboard').classList.contains('hidden')) {
                updateAdminDashboard();
            }
            if (currentRole === 'worker' && !document.getElementById('worker-dashboard').classList.contains('hidden')) {
                updateWorkerDashboard();
            }
            updateLoansDisplay();
            updateServicesDisplay();
            updateWorkerActivity();
        }

        function setupListeners() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
                }
            });

            // Auto-save every 30 seconds - use requestIdleCallback if available
            setInterval(() => {
                if (isOnline) {
                    // Use requestAnimationFrame to prevent blocking
                    requestAnimationFrame(() => {
                        saveToFirebase();
                    });
                } else {
                    requestAnimationFrame(() => {
                        saveLocalData();
                    });
                }
            }, 30000);
        }

        function setupTheme() {
            const savedTheme = localStorage.getItem('okasha_theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.querySelector('#theme-toggle i').className = 'fas fa-sun text-yellow-500';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.querySelector('#theme-toggle i');
            if (document.body.classList.contains('light-mode')) {
                icon.className = 'fas fa-sun text-yellow-500';
                localStorage.setItem('okasha_theme', 'light');
            } else {
                icon.className = 'fas fa-moon text-blue-400';
                localStorage.setItem('okasha_theme', 'dark');
            }
            
            // Update charts if open
            if (document.getElementById('analytics-modal').classList.contains('active')) {
                setTimeout(initializeCharts, 100);
            }
        }

        // ==================== INITIAL LOG ====================
        console.log("=========================================");
        console.log(" COMPLETE PROFESSIONAL POS SYSTEM v6.2");
        console.log(" INP ISSUE FIXED");
        console.log("=========================================");
        console.log("Shop:", SHOP_DETAILS.name);
        console.log("Location:", SHOP_DETAILS.address);
        console.log("Easypaisa:", SHOP_DETAILS.easypaisa);
        console.log("Bank:", SHOP_DETAILS.bank);
        console.log("=========================================");
        console.log(" ALL FEATURES WORKING:");
        console.log(" Product Add/Delete");
        console.log(" Image Upload & Display");
        console.log(" Worker Services (Easyload, Print, Forms)");
        console.log(" Cash / Easypaisa / JazzCash / Bank / Loan");
        console.log(" Real-time Cloud Sync");
        console.log("=========================================");
        console.log("Default Passwords:");
        console.log("Admin: adminmb123");
        console.log("Worker: worker3214");
        console.log("=========================================");
    </script>
</body>
</html>
